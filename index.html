<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Treino — Bastão Extensível (54.º / 55.º / PDF / Extra)</title>
<style>
  :root{ --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --mute:#94a3b8; --acc:#22d3ee; --good:#22c55e; --bad:#ef4444; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,#0b1220 0,#0b1220ee 70%,#0b1220cc 100%),radial-gradient(1100px 500px at 110% -10%,#1f2937 0,#0b1220 60%);border:1px solid #1f2937;border-radius:18px;padding:20px 18px;box-shadow:0 10px 30px #0006}
  h1{font-size:1.6rem;margin:0 0 6px}
  .sub{color:var(--mute);margin:0 0 18px}
  select,button{font:inherit;color:var(--ink);background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
  select:focus,button:focus{outline:2px solid var(--acc);outline-offset:2px}
  button.primary{background:#0b1220;border-color:#334155}
  button.primary:hover{border-color:#475569}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;gap:10px;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:8px 12px;font-size:.95rem;color:var(--mute)}
  .q{margin:14px 0 18px;padding:16px;border:1px solid #1f2937;border-radius:14px;background:#0b1220b3}
  .q h3{font-size:1rem;margin:0 0 10px}
  .opts{display:grid;gap:8px}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid #1f2937;border-radius:10px;background:#0b1220}
  .opt input{margin-top:3px;accent-color:var(--acc)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;font-size:.8rem}
  .ok{background:color-mix(in srgb, var(--good) 20%, transparent);border:1px solid var(--good);color:#bbf7d0}
  .ko{background:color-mix(in srgb, var(--bad) 15%, transparent);border:1px solid var(--bad);color:#fecaca}
  .explain{color:var(--mute);margin-top:8px;font-size:.94rem}
  .sticky{position:sticky;top:0;z-index:3;background:linear-gradient(#0f172a,#0f172aCC 80%,transparent);padding:10px 0 6px;margin:-10px 0 10px}
  .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-top:16px}
  .counts{display:flex;gap:8px;flex-wrap:wrap}
  .k{border:1px solid #1f2937;border-radius:10px;padding:6px 10px;color:var(--mute)}
  .score{font-weight:700}
  .muted{color:var(--mute)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Quiz — Bastão Extensível (CFG 54.º / 55.º / PDF / Extra)</h1>
    <p class="sub">30 perguntas de escolha múltipla. Seleciona o teste, responde e só no final verás a correção e a nota (0–20).</p>
    <div class="row" style="margin-bottom:12px">
      <label for="testSel" class="pill">Escolher teste:
        <select id="testSel" style="margin-left:8px">
          <option value="54">54.º Curso</option>
          <option value="55">55.º Curso</option>
          <option value="pdf">PDF (novo)</option>
          <option value="extra">Extra (novo)</option>
        </select>
      </label>
      <button id="startBtn" class="primary">Começar / Reiniciar</button>
      <span class="pill">Progresso: <span id="prog">0/30</span></span>
      <span class="pill">Estado: <span id="state">Em resposta</span></span>
    </div>

    <div id="quizArea"></div>

    <div class="sticky">
      <div class="footer">
        <div class="counts">
          <span class="k">Certas: <strong id="cRight">0</strong></span>
          <span class="k">Erradas: <strong id="cWrong">0</strong></span>
          <span class="k">Em branco: <strong id="cBlank">30</strong></span>
          <span class="k score">Nota (/20): <strong id="score">–</strong></span>
        </div>
        <div class="row">
          <button id="submitBtn" class="primary">Entregar</button>
          <button id="exportBtn" title="Exportar resultados para .txt" disabled>Exportar .txt</button>
          <button id="clearBtn" title="Limpar progresso">Limpar</button>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:8px">Baralha perguntas e opções a cada início. Progresso guardado localmente (por teste).</p>
  </div>
</div>

<script>
/* ===== Utilitários e motor base ===== */
function q(stem, options, correctIndex, explanation){ return { stem, options, correctIndex, explanation }; }
function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function uid(){ return Math.random().toString(36).slice(2) }
const el = (q)=>document.querySelector(q);
const $quiz = el('#quizArea'), $prog = el('#prog'), $state = el('#state'), $score = el('#score');
const $cRight = el('#cRight'), $cWrong = el('#cWrong'), $cBlank = el('#cBlank');
const $submit = el('#submitBtn'), $start = el('#startBtn'), $export = el('#exportBtn'), $clear = el('#clearBtn'), $sel = el('#testSel');

let CURRENT = { testId:'54', items:[], answers:{}, key:{}, locked:false, evaluated:false, seed:'' };
function storageKey(){ return `be_quiz_${CURRENT.testId}`; }
function saveState(){ localStorage.setItem(storageKey(), JSON.stringify({ answers:CURRENT.answers, seed:CURRENT.seed })); }
function loadState(){ const raw=localStorage.getItem(storageKey()); if(!raw) return null; try{ return JSON.parse(raw) }catch{ return null } }

/* ===== Bancos existentes (resumo) =====
   Se já tens os TEST_54, TEST_55 e TEST_PDF no teu ficheiro anterior, podes manter.
   Incluo aqui versões compactas apenas para manter o ficheiro autónomo. */
const TEST_54 = [
  q("As sete componentes da potência são:", ["Equilíbrio, flexibilidade, coordenação, resistência, simplicidade, velocidade, força","Coordenação, potência, rotatividade, simplicidade, velocidade, força, foco","Equilíbrio, precisão, coordenação, resistência, simplicidade, velocidade, força","Equilíbrio, flexibilidade, coordenação, resistência, complexidade, velocidade, força"], 0, "As 7: equilíbrio, flexibilidade, coordenação, resistência, simplicidade, velocidade, força."),
  q("Intervenção policial em equipa permite:", ["Atuar simultaneamente em diferentes patamares do uso da força","Reduzir a necessidade de comunicação","Substituir a mínima força","Eliminar avaliação do risco"], 0, ""),
  q("Triângulo da decisão integra:", ["Habilidade, Oportunidade e Risco","Legalidade, Necessidade e Proporcionalidade","Tempo, Distância e Cobertura","Força, Velocidade e Resistência"], 0, "HOR."),
  q("Posição policial assenta em:", ["Estabilidade lateral e frontal, centro de gravidade baixo e cabeça ao centro","Estabilidade frontal, cabeça baixa, pés paralelos","Base estreita, tronco à frente, braços estendidos","Base alta, braços cruzados, olhar fixo"], 0, ""),
  q("Uso da força (mínima/proporcionalidade) pode ser entendido como:", ["Uma opção do ADV após advertência","Um automatismo do militar","Decisão exclusiva do comandante","Inevitável no primeiro contacto"], 0, ""),
  q("No modo fechado, controlo que NÃO pode ser feito de ambos os lados:", ["Controlo ao tríceps","Controlo ao bíceps","Controlo ao pulso","Chave"], 0, ""),
  q("Segundo RGAM, o BE é arma de:", ["Classe A","Classe B","Classe C","Classe D"], 0, ""),
  q("Abertura 'para baixo' quando:", ["O espaço é reduzido","Pretende-se máxima visibilidade","Terreno escorregadio","Vento lateral forte"], 0, ""),
  q("Impacto em zonas amarelas executa-se:", ["Quando as técnicas nas zonas verdes se revelem ineficazes","Como primeira opção","Apenas em multidões","Só em treino"], 0, ""),
  q("Afastamento (fechado) com rotação do pulso:", ["Polegar abandona a ponta e fica por cima do indicador","Polegar une ao médio","Polegar por baixo do indicador","Roda só a mão de defesa"], 0, ""),
  q("BE é utilizado para:", ["Controlar e deter","Dispersar multidões","Imobilizar permanentemente","Substituir arma de fogo"], 0, ""),
  q("Direto (fechado) destros:", ["Diagonal direita→esquerda","Horizontal esquerda→direita","Vertical ascendente","Arco por cima da cabeça"], 0, ""),
  q("Posição de intervenção foi concebida para:", ["Maximizar disponibilidade e postura defensiva","Favorecer deslocamentos sacrificando estabilidade","Aumentar alcance acima da cabeça","Eliminar mão de defesa"], 0, ""),
  q("Componente mais essencial da potência:", ["Equilíbrio","Força","Velocidade","Resistência"], 0, ""),
  q("Condição física influencia porque:", ["Afeta discernimento e decisão","Substitui a técnica","Elimina risco","Dispensa equipa"], 0, ""),
  q("BE e bastão de borracha são:", ["Ferramentas diferentes que se complementam","Intercambiáveis","Ambos para dispersão","Ambos rígidos e discretos"], 0, ""),
  q("Constituição do BE:", ["Base, pega, guarda, corpo médio, corpo final e ponta","Empunhadura, lâmina, guarda, corpo","Pega, mola, gatilho e ponta","Cabo, corrente e peso terminal"], 0, ""),
  q("Posição com mais estabilidade:", ["Posição de intervenção","Descanso","Corrida","Apresentação"], 0, ""),
  q("Em modo aberto, técnicas com:", ["Últimos ~7 cm do corpo final e a ponta","A base","Zona média do corpo médio","Qualquer parte"], 0, ""),
  q("Definição legal do BE:", ["Instrumento portátil telescópico, rígido ou flexível","Arma de borracha","Artefacto pirotécnico","Dispositivo elétrico"], 0, ""),
  q("Atuação preferencial do BE:", ["Grandes massas musculares dos membros","Cabeça e pescoço","Coluna vertebral","Genitais"], 0, ""),
  q("Locais a evitar:", ["Cabeça, pescoço, externo, coluna, genitais","Braços e coxas","Antebraços e gémeos","Quadríceps e deltoides"], 0, ""),
  q("Distância de segurança serve para:", ["Controlar o impulso do ADV","Permitir fuga do ADV","Evitar controlo","Garantir abertura para cima"], 0, ""),
  q("Abrir e fechar:", ["Inércia e fricção","Fricção e inércia","Compressão e fricção","Inércia e compressão"], 0, ""),
  q("Funda — caraterísticas:", ["Rígida, rotativa e adaptável","Flexível e fixa","Rígida, fechada e não rotativa","Maleável e solta"], 0, ""),
  q("Espaço amplo + visibilidade:", ["Abertura para cima","Para baixo","Horizontal","Não abrir"], 0, ""),
  q("Técnicas atuam:", ["Centro de massa dos membros","Cabeça e pescoço","Tronco superior/cervical","Tornozelos e mãos"], 0, ""),
  q("Flexibilidade relaciona-se com:", ["Tensão/nervosismo/falta de confiança","Força máxima","Envergadura","Peso do equipamento"], 0, ""),
  q("Equipa permite:", ["Patamares diferentes coordenados","Eliminar avaliação de risco","Dispensar distância","Reduzir comunicação"], 0, ""),
  q("Zonas amarelas destinam-se a:", ["Controlo/imobilização (articulações)","Impacto inicial","Dissuadir à distância","Pressão contínua em músculos"], 0, "")
];

const TEST_55 = [
  q("Abertura 'para baixo' quando:", ["O espaço é reduzido","Máximo impacto psicológico","Terreno macio","Necessidade de luz"], 0, ""),
  q("Abrir e fechar do BE:", ["Inércia e fricção","Fricção e inércia","Compressão e mola","Alavanca e mola"], 0, ""),
  q("Mínima força e proporcionalidade podem ser entendidas como:", ["Opção do ADV após advertência","Automatismo","Decisão só do superior","Resposta fixa"], 0, ""),
  q("Componente essencial da potência:", ["Equilíbrio","Força","Velocidade","Resistência"], 0, ""),
  q("Impacto com BE atua sobre:", ["Sistema motor","Respiratório","Circulatório","Digestivo"], 0, ""),
  q("Sete componentes:", ["Equilíbrio, flexibilidade, coordenação, resistência, simplicidade, velocidade, força","Equilíbrio, flexibilidade, coordenação, potência, velocidade, força, foco","Resistência, elasticidade, coordenação, simplicidade, velocidade, força, foco","Equilíbrio, precisão, coordenação, resistência, simplicidade, velocidade, força"], 0, ""),
  q("Afastamento (fechado):", ["Polegar abandona a ponta e fica por cima do indicador","Polegar por baixo do indicador","Polegar permanece na ponta","Polegar roda para a palma"], 0, ""),
  q("Controlo em fechado não executável dos dois lados:", ["Tríceps","Bíceps","Pulso","Chave"], 0, ""),
  q("Reação (fechado) executa-se quando:", ["Direto anterior foi ineficaz","Dois ADV","Para iniciar intervenção","ADV imobilizado"], 0, ""),
  q("Classe legal do BE:", ["Classe A","Classe B","Classe C","Classe D"], 0, ""),
  q("Flexibilidade relaciona-se com:", ["Tensão/nervosismo/falta de confiança","Força absoluta","Velocidade de reação","Só amplitude"], 0, ""),
  q("Triângulo da decisão:", ["Habilidade, oportunidade e risco","Tempo, distância e cobertura","Legalidade, necessidade e adequação","Força, velocidade e resistência"], 0, ""),
  q("Funda — caraterísticas:", ["Rígida, rotativa e adaptável","Flexível e não ajustável","Fina e descartável","Rígida e não rotativa"], 0, ""),
  q("Direto (fechado) destros:", ["Diagonal direita→esquerda","Horizontal esquerda→direita","Vertical ascendente","Arco por cima da cabeça"], 0, ""),
  q("Posição de intervenção:", ["Maximiza disponibilidade e defesa","Aumenta velocidade de corrida","Facilita golpes acima da cabeça","Dispensa mão de defesa"], 0, ""),
  q("Equipa destaca-se por permitir:", ["Patamares distintos coordenados","Eliminar avaliação de risco","Evitar comunicações","Trocar legalidade por eficácia"], 0, ""),
  q("Posição policial — 4 componentes:", ["Estabilidade lateral e frontal, centro de gravidade baixo e cabeça ao centro","Base estreita, tronco à frente...","Estabilidade frontal, cabeça baixa...","Base alta, braços cruzados..."], 0, ""),
  q("Locais a evitar:", ["Cabeça, pescoço, externo, coluna, genitais","Braços e coxas","Antebraços e gémeos","Deltoides e quadríceps"], 0, ""),
  q("Distância de segurança permite:", ["Controlar o impulso do ADV","Eliminar BE","Aplicar pressão contínua","Garantir mobilidade do ADV"], 0, ""),
  q("BE vs bastão de borracha:", ["Ferramentas diferentes e complementares","Igual finalidade","Ambos para dispersão","Ambos flexíveis"], 0, ""),
  q("Constituição do BE:", ["Base, pega, guarda, corpo médio, corpo final e ponta","Empunhadura, lâmina, guarda e corpo","Cabo, corrente e peso terminal","Pega, mola, gatilho e ponta"], 0, ""),
  q("Posição com mais estabilidade:", ["Intervenção","Descanso","Apresentação","Avanço"], 0, ""),
  q("Em modo aberto usar:", ["Últimos ~7 cm do corpo final e a ponta","Base","Zona média","Qualquer parte"], 0, ""),
  q("Definição legal:", ["Instrumento portátil telescópico, rígido ou flexível","Arma de borracha","Dispositivo elétrico","Instrumento perfurante"], 0, ""),
  q("BE é utilizado para:", ["Controlar e deter","Dispersar grupos","Substituir algemas","Arma elétrica"], 0, ""),
  q("Zonas amarelas são usadas quando:", ["Verdes se revelam ineficazes","Início da intervenção","Dissuadir sonora","ADV rendido"], 0, ""),
  q("Abertura 'para cima' dá:", ["Máxima visibilidade","Menor controlo","Mais discrição sonora","Acesso mais lento"], 0, ""),
  q("Técnicas atuam:", ["Centro de massa dos membros","Preferencialmente cabeça","Maioritariamente tronco","Mãos e pés"], 0, ""),
  q("Funda deve permitir:", ["Colocação/extração inclusive com BE aberto","Apenas com BE fechado","Fixação frouxa","Rotação impedida"], 0, ""),
  q("Objetivo principal do BE:", ["Deter e controlar (não dispersar)","Dispersar com menor lesividade","Substituir arma de fogo","Causar dor"], 0, "")
];

const TEST_PDF = [
  /* (Mantém aqui o teu TEST_PDF com 30 Qs do ficheiro que enviaste) */
];

/* ===== NOVO — TESTE EXTRA (30 perguntas inéditas) ===== */
const TEST_EXTRA = [
  q("O princípio da necessidade implica que o uso do BE:", [
    "Seja apenas o necessário para alcançar o objetivo legítimo",
    "Seja maximizado para terminar mais depressa",
    "Substitua sempre técnicas de controlo manual",
    "Seja aplicado após qualquer desobediência, sem gradação"
  ], 0, "Necessidade = só o indispensável para o fim legal."),
  q("O princípio da adequação exige que:", [
    "O meio seja idóneo para o resultado pretendido",
    "Se escolha o meio mais doloroso",
    "Se use sempre a mesma técnica padrão",
    "Se ignore o contexto físico envolvente"
  ], 0, "Adequação = idoneidade do meio ao objetivo."),
  q("A proporcionalidade no uso do BE avalia:", [
    "Relação entre gravidade da ameaça e intensidade do meio usado",
    "Tempo gasto na intervenção",
    "Número de intervenientes policiais",
    "Tamanho do equipamento"
  ], 0, "Proporcionalidade: equilíbrio ameaça/meio."),
  q("A mínima força significa:", [
    "Preferir a intervenção menos lesiva que funcione",
    "Evitar qualquer contacto físico",
    "Usar sempre BE antes de diálogo",
    "Usar força máxima por pouco tempo"
  ], 0, "Escolher a via eficaz menos gravosa."),
  q("A verbalização táctica antes do uso do BE visa sobretudo:", [
    "Dissuadir e clarificar consequências legais",
    "Cumprir um formalismo irrelevante",
    "Ganhar tempo para a equipa chegar",
    "Elevar o tom para provocar submissão"
  ], 0, "De-escalada e clarificação."),
  q("Numa abordagem em equipa, o princípio de ‘canais cruzados’ significa:", [
    "Separar funções: contacto, cobertura, comunicação e contenção",
    "Ambos os militares falarem em simultâneo",
    "Todos os militares aplicarem o mesmo patamar",
    "Rodar posições continuamente sem critério"
  ], 0, "Funções claras e complementares."),
  q("O ângulo de abordagem mais seguro tende a ser:", [
    "Ligeiramente oblíquo fora da linha central do ADV",
    "Frontal, a curta distância",
    "Pelas costas sem anúncio",
    "Lateral com braços cruzados"
  ], 0, "Evita linha direta de ataque, mantém visão."),
  q("Retenção do BE refere-se a:", [
    "Medidas para prevenir que o ADV agarre/roube o bastão",
    "Colocar o bastão na funda",
    "Guardar o bastão no armário",
    "Reduzir o comprimento do bastão"
  ], 0, "Retention = impedir perda/roubo."),
  q("Transição BE → algemas deve ocorrer:", [
    "Quando há controlo estável e segurança para passar à imobilização",
    "Assim que o ADV cai",
    "Logo ao primeiro contacto",
    "Apenas por ordem superior"
  ], 0, "Só com controlo e segurança."),
  q("A gestão de distância ‘reação + segurança’ permite:", [
    "Tempo de decisão e espaço para resposta",
    "Reduzir a efetividade de técnicas",
    "Obrigar o ADV a avançar",
    "Eliminar necessidade de cobertura"
  ], 0, "Tempo + espaço = decisão melhor."),
  q("Em escadas/corredores estreitos, o risco principal é:", [
    "Perda de mobilidade e fuga de rota",
    "Demasiada visibilidade",
    "Ruído excessivo do bastão",
    "Falta de luz no bastão"
  ], 0, "Ambiente confinado aumenta risco."),
  q("A funda rotativa bem ajustada serve para:", [
    "Facilitar extração/colocação e ajustar ângulo conforme a tarefa",
    "Impedir qualquer rotação por segurança",
    "Carregar outro equipamento dentro",
    "Substituir o coldre da arma de fogo"
  ], 0, "Ergo + acessibilidade."),
  q("A inspeção do BE antes de serviço inclui:", [
    "Verificar fixação das secções e integridade da pega",
    "Lubrificar abundantemente o interior",
    "Bater no chão para ‘testar’",
    "Aquecer as secções para dilatar"
  ], 0, "Checagem funcional e visual."),
  q("Sobre manutenção do BE, é correto dizer:", [
    "Manter limpo e seco; evitar detritos que prejudiquem abrir/fechar",
    "Lubrificar com óleo espesso no interior",
    "Guardar sempre aberto para ventilar",
    "Lavar com solventes agressivos"
  ], 0, "Sujo = falhas de travamento."),
  q("A escolha entre abrir ‘para cima’ ou ‘para baixo’ deve considerar:", [
    "Espaço disponível e necessidade de visibilidade",
    "Preferência pessoal apenas",
    "A cor da farda",
    "A orientação do vento"
  ], 0, "Critérios operacionais."),
  q("Após intervenção bem-sucedida, deve-se:", [
    "Assegurar segurança, prestar primeiros socorros e comunicar/relatar",
    "Guardar o BE e sair",
    "Não tocar em ninguém para evitar relatórios",
    "Aguardar que o ADV recupere sozinho"
  ], 0, "Sequência ética/legal."),
  q("Numa multidão, o BE é preferencialmente:", [
    "Ferramenta de controlo de indivíduo específico",
    "Ferramenta de dispersão generalizada",
    "Substituto de barreiras físicas",
    "Sinalizador de direção"
  ], 0, "Foco individual, não dispersão."),
  q("O uso de BE em ‘zonas vermelhas’:", [
    "É proibido salvo risco grave e excecional de vida",
    "É a primeira opção",
    "É sempre aceitável se o ADV foge",
    "É adequado para causar dor"
  ], 0, "Regra de exceção estrita."),
  q("A coordenação com meios de menor potencial ofensivo (ex.: OC) visa:", [
    "Expandir opções para de-escalada e controlo",
    "Dispensar avaliação de risco",
    "Reduzir documentação",
    "Evitar formação técnica"
  ], 0, "Mais opções, melhor decisão."),
  q("O reporte pós-uso de força deve registar:", [
    "Contexto, meios usados, avaliação, lesões e justificações",
    "Apenas as ordens recebidas",
    "Somente a hora",
    "Informação sensível omitida por regra"
  ], 0, "Rastreabilidade e legalidade."),
  q("Sobre ética e imagem institucional:", [
    "Uso correto e proporcional do BE protege a confiança pública",
    "Não tem impacto na confiança",
    "Apenas a rapidez importa",
    "Quanto mais força, melhor imagem"
  ], 0, "Proporcionalidade = confiança."),
  q("Durante treino, medida de segurança essencial:", [
    "Proteções, instruções claras e supervisão qualificada",
    "Dispensar aquecimento",
    "Usar objetos improvisados",
    "Treinar em pisos escorregadios"
  ], 0, "Segurança primeiro."),
  q("Em ambientes com obstáculos (mobiliário), o militar deve:", [
    "Reconfigurar posição/ângulo para manter linha de visão e fuga",
    "Forçar confronto imediato",
    "Desconsiderar tralhas",
    "Fixar os pés e não ajustar"
  ], 0, "Leitura do terreno."),
  q("Num veículo (porta aberta), prioridade é:", [
    "Impedir fecho súbito da porta e controlar ângulo",
    "Golpear vidros de imediato",
    "Entrar no habitáculo rapidamente",
    "Ignorar cinto de segurança do ADV"
  ], 0, "Segurança e controlo de ângulos."),
  q("Sinais de ‘pré-ataque’ do ADV incluem:", [
    "Olhar fixo, postura tensa, mãos escondidas",
    "Respiração calma e mãos visíveis",
    "Comunicação aberta e relaxada",
    "Afirmações de cooperação e distância mantida"
  ], 0, "Indicadores comportamentais."),
  q("Quando a comunicação do ADV é confusa, o militar deve:", [
    "Usar instruções curtas, claras e repetir verificação",
    "Aumentar volume e aproximar",
    "Ignorar e aplicar força",
    "Desviar o olhar e gesticular"
  ], 0, "Clareza e controlo."),
  q("Transição BE → arma de fogo é considerada quando:", [
    "A ameaça excede claramente o potencial do BE",
    "O ADV discorda verbalmente",
    "Há espaço amplo e luz",
    "O militar se sente cansado"
  ], 0, "Escalada por necessidade/legalidade."),
  q("Indicador de pega correta no BE:", [
    "Pega firme sem tensão excessiva na mão dominante",
    "Dedo indicador estendido na ponta",
    "Polegar a envolver completamente a ponta",
    "Pegas alternadas a cada impacto"
  ], 0, "Controlo sem fadiga."),
  q("Num trabalho a dois, o ‘check-in’ constante serve para:", [
    "Atualizar perceção comum e evitar ações contraditórias",
    "Substituir ordens superiores",
    "Reduzir documentação",
    "Acelerar encerramento sem avaliação"
  ], 0, "Partilha situacional."),
  q("A decisão de não usar o BE (abstenção):", [
    "Pode ser a opção correta se de-escalada funcionar",
    "É sempre sinal de fraqueza",
    "É proibida",
    "Viola o dever de agir"
  ], 0, "Objetivo é resolver com segurança e legalidade.")
];

/* ===== Seletor do banco ===== */
function pool(testId){
  if(testId==='54') return TEST_54;
  if(testId==='55') return TEST_55;
  if(testId==='pdf') return TEST_PDF;
  return TEST_EXTRA;
}

/* ===== Construção / avaliação ===== */
function build(testId){
  CURRENT.testId = testId;
  const base = pool(testId);
  const seed = uid(); CURRENT.seed = seed;
  const items = shuffle(base).map((q,i)=>{
    const idxs = shuffle([0,1,2,3]);
    const opts = idxs.map(k=>q.options[k]);
    const correct = idxs.indexOf(q.correctIndex);
    return { id:`${testId}-${i+1}`, stem:q.stem, opts, correct, explanation:q.explanation||'' };
  });
  CURRENT.items = items.slice(0,30);
  CURRENT.answers = {};
  CURRENT.key = Object.fromEntries(CURRENT.items.map(it=>[it.id, it.correct]));
  CURRENT.locked = false; CURRENT.evaluated = false;
  render();
  localStorage.removeItem(storageKey()); // limpar estado antigo do mesmo teste
  updateCounts();
}

function render(){
  $quiz.innerHTML = '';
  CURRENT.items.forEach((q, idx)=>{
    const wrap = document.createElement('div'); wrap.className='q'; wrap.dataset.qid=q.id;
    const h = document.createElement('h3'); h.innerHTML = `<span class="muted">Q${idx+1}.</span> ${q.stem}`;
    const opts = document.createElement('div'); opts.className='opts';
    q.opts.forEach((opt, i)=>{
      const id = `${q.id}-o${i}`;
      const line = document.createElement('label'); line.className='opt';
      line.innerHTML = `<input type="radio" name="${q.id}" id="${id}" value="${i}"><div>${opt}</div>`;
      opts.appendChild(line);
    });
    wrap.appendChild(h); wrap.appendChild(opts); $quiz.appendChild(wrap);
  });
  $state.textContent='Em resposta'; $score.textContent='–';
  $cRight.textContent='0'; $cWrong.textContent='0'; $cBlank.textContent='30';
  $export.disabled = true;
  $quiz.addEventListener('change', onSelect, { once:false, passive:true });
}

function onSelect(e){
  if(!e.target || e.target.type!=='radio') return;
  if(CURRENT.locked) return;
  const name = e.target.name, val = Number(e.target.value);
  CURRENT.answers[name] = val; saveState(); updateCounts();
}

function updateCounts(){
  const answered = Object.keys(CURRENT.answers).length;
  $prog.textContent = `${answered}/30`; $cBlank.textContent = String(30-answered);
}

function evaluate(){
  CURRENT.locked = true; CURRENT.evaluated = true; $state.textContent='Corrigido';
  let right=0, wrong=0;
  document.querySelectorAll('.q').forEach(qEl=>{
    const qid = qEl.dataset.qid;
    const item = CURRENT.items.find(x=>x.id===qid);
    const chosen = CURRENT.answers[qid];
    const correct = item.correct;

    const labels = qEl.querySelectorAll('.opt');
    labels.forEach((lab, i)=>{
      const input = lab.querySelector('input'); input.disabled = true;
      if(i===correct){ lab.classList.add('ok'); }
      if(chosen!==undefined && i===chosen && chosen!==correct){ lab.classList.add('ko'); }
    });

    const badge = document.createElement('span');
    badge.className = 'badge ' + (chosen===correct ? 'ok' : (chosen===undefined ? 'ko' : 'ko'));
    badge.textContent = (chosen===correct ? 'Correto' : (chosen===undefined ? 'Em branco' : 'Incorreto'));
    qEl.querySelector('h3').appendChild(document.createTextNode(' '));
    qEl.querySelector('h3').appendChild(badge);

    const exp = document.createElement('div'); exp.className='explain';
    exp.innerHTML = `<strong>Resposta correta:</strong> ${item.opts[correct]}${item.explanation?` — <em>${item.explanation}</em>`:''}`;
    qEl.appendChild(exp);

    if(chosen===correct) right++; else if(chosen!==undefined) wrong++;
  });

  const blanks = 30 - (right + wrong);
  const note20 = (right/30)*20;
  $cRight.textContent = String(right);
  $cWrong.textContent = String(wrong);
  $cBlank.textContent = String(blanks);
  $score.textContent = note20.toFixed(1);
  $export.disabled = false;
  saveState();
}

function exportTxt(){
  const lines = [];
  lines.push(`Teste ${CURRENT.testId} — Resultados`);
  lines.push(`Certas: ${$cRight.textContent}`);
  lines.push(`Erradas: ${$cWrong.textContent}`);
  lines.push(`Em branco: ${$cBlank.textContent}`);
  lines.push(`Nota (/20): ${$score.textContent}`); lines.push('');
  CURRENT.items.forEach((it, i)=>{
    const chosen = CURRENT.answers[it.id];
    const mark = (chosen===undefined) ? '—' : String.fromCharCode(65+chosen);
    const ok = String.fromCharCode(65+it.correct);
    lines.push(`Q${i+1}. ${it.stem}`);
    it.opts.forEach((op, idx)=>{ const tag=String.fromCharCode(65+idx); const sel=(idx===chosen)?'*':' '; const cor=(idx===it.correct)?' (correta)':''; lines.push(`  ${sel} ${tag}) ${op}${cor}`);});
    lines.push(`  → Tua resposta: ${mark} | Correta: ${ok}`);
    if(it.explanation) lines.push(`  Obs.: ${it.explanation}`); lines.push('');
  });
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = `resultado_teste_${CURRENT.testId}.txt`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function clearProgress(){ localStorage.removeItem(storageKey()); build($sel.value); }

/* Eventos UI */
$start.addEventListener('click', ()=>build($sel.value));
$submit.addEventListener('click', ()=>{
  const answered = Object.keys(CURRENT.answers).length;
  if(answered<30){ const remain = 30-answered; if(!confirm(`Tens ${remain} pergunta(s) por responder. Queres entregar na mesma?`)) return; }
  evaluate();
});
$export.addEventListener('click', exportTxt);
$clear.addEventListener('click', clearProgress);
$sel.addEventListener('change', ()=>build($sel.value));

/* Start */
build($sel.value);
</script>
</body>
</html>
