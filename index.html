<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz — CDF + Bastão Extensível (54.º/55.º)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --mute:#94a3b8; --acc:#22d3ee; --good:#22c55e; --bad:#ef4444;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,#0b1220 0,#0b1220ee 70%,#0b1220cc 100%),radial-gradient(1100px 500px at 110% -10%,#1f2937 0,#0b1220 60%);border:1px solid #1f2937;border-radius:18px;padding:20px 18px;box-shadow:0 10px 30px #0006}
  h1{font-size:1.6rem;margin:0 0 6px}
  .sub{color:var(--mute);margin:0 0 18px}
  select,button{font:inherit;color:var(--ink);background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
  select:focus,button:focus{outline:2px solid var(--acc);outline-offset:2px}
  button.primary{background:#0b1220;border-color:#334155}
  button.primary:hover{border-color:#475569}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;gap:10px;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:8px 12px;font-size:.95rem;color:var(--mute)}
  .q{margin:14px 0 18px;padding:16px;border:1px solid #1f2937;border-radius:14px;background:#0b1220b3}
  .q h3{font-size:1rem;margin:0 0 10px}
  .opts{display:grid;gap:8px}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid #1f2937;border-radius:10px;background:#0b1220}
  .opt input{margin-top:3px;accent-color:var(--acc)}
  .disabled{pointer-events:none;opacity:.8}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;font-size:.8rem}
  .ok{background:color-mix(in srgb, var(--good) 20%, transparent);border:1px solid var(--good);color:#bbf7d0}
  .ko{background:color-mix(in srgb, var(--bad) 15%, transparent);border:1px solid var(--bad);color:#fecaca}
  .explain{color:var(--mute);margin-top:8px;font-size:.94rem}
  .sticky{position:sticky;top:0;z-index:3;background:linear-gradient(#0f172a,#0f172aCC 80%,transparent);padding:10px 0 6px;margin:-10px 0 10px}
  .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-top:16px}
  .counts{display:flex;gap:8px;flex-wrap:wrap}
  .k{border:1px solid #1f2937;border-radius:10px;padding:6px 10px;color:var(--mute)}
  .score{font-weight:700}
  .muted{color:var(--mute)}
  .warning{border-left:4px solid #f59e0b;padding:10px 12px;border-radius:8px;background:#0b1220;margin:10px 0;color:#fde68a}
  @media (prefers-reduced-motion:no-preference){
    .q{transition:transform .15s ease, background .2s ease}
    .q:hover{transform:translateY(-1px)}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Quiz — CDF + Bastão Extensível (54.º/55.º)</h1>
    <p class="sub">Seleciona o teste, responde às 30 questões e só no fim verás a correção e a nota (/20). O novo teste “CDF” baralha 30 perguntas de um banco ~50.</p>
    <div class="row" style="margin-bottom:12px">
      <label for="testSel" class="pill">Escolher teste:
        <select id="testSel" style="margin-left:8px">
          <option value="54">54.º Curso</option>
          <option value="55">55.º Curso</option>
          <option value="CDF">Conceção & Dinâmicas da Formação (CDF)</option>
        </select>
      </label>
      <button id="startBtn" class="primary">Começar / Reiniciar</button>
      <span class="pill">Progresso: <span id="prog">0/30</span></span>
      <span class="pill">Estado: <span id="state">Em resposta</span></span>
    </div>

    <div id="quizArea"></div>

    <div class="sticky">
      <div class="footer">
        <div class="counts">
          <span class="k">Certas: <strong id="cRight">0</strong></span>
          <span class="k">Erradas: <strong id="cWrong">0</strong></span>
          <span class="k">Em branco: <strong id="cBlank">30</strong></span>
          <span class="k score">Nota (/20): <strong id="score">–</strong></span>
        </div>
        <div class="row">
          <button id="submitBtn" class="primary">Entregar</button>
          <button id="exportBtn" title="Exportar resultados para .txt" disabled>Exportar .txt</button>
          <button id="clearBtn" title="Limpar progresso">Limpar</button>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:8px">As perguntas e opções baralham a cada início. Progresso guardado localmente (por teste).</p>
  </div>
</div>

<script>
/* ---------- Utilidades ---------- */
function q(stem, options, correctIndex, explanation){
  return { stem, options, correctIndex, explanation };
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function uid(){ return Math.random().toString(36).slice(2) }

const el = (q)=>document.querySelector(q);
const $quiz = el('#quizArea');
const $prog = el('#prog');
const $state = el('#state');
const $score = el('#score');
const $cRight = el('#cRight');
const $cWrong = el('#cWrong');
const $cBlank = el('#cBlank');
const $submit = el('#submitBtn');
const $start = el('#startBtn');
const $export = el('#exportBtn');
const $clear = el('#clearBtn');
const $sel = el('#testSel');

let CURRENT = { testId:'54', items:[], answers:{}, key:{}, locked:false, evaluated:false, seed:'' };
function storageKey(){ return `be_quiz_${CURRENT.testId}`; }
function saveState(){
  const data = { answers:CURRENT.answers, seed:CURRENT.seed };
  localStorage.setItem(storageKey(), JSON.stringify(data));
}
function loadState(){
  const raw = localStorage.getItem(storageKey());
  if(!raw) return null;
  try { return JSON.parse(raw) } catch { return null }
}

/* ---------- Bancos existentes (placeholder resumido) ----------
   Mantém aqui os teus TEST_54 e TEST_55 originais (não alterei conteúdo).
   Para o exemplo, deixo 2 itens dummy por banco — substitui-os pelos teus.
*/
const TEST_54 = [
  q("Dummy 54 #1", ["A","B","C","D"], 0, ""),
  q("Dummy 54 #2", ["A","B","C","D"], 1, "")
];
const TEST_55 = [
  q("Dummy 55 #1", ["A","B","C","D"], 2, ""),
  q("Dummy 55 #2", ["A","B","C","D"], 3, "")
];

/* ---------- NOVO BANCO: TEST_CDF (~50 itens) ---------- */
const TEST_CDF = [
  // 1 MSF – conceito/finalidade
  q("O Modelo Sistémico de Formação (MSF) é:", [
    "Uma adaptação de engenharia de sistemas para soluções de formação eficientes e económicas",
    "Um calendário padrão de aulas e avaliações",
    "Um conjunto de técnicas de aula expositiva",
    "Um formulário para controlo de assiduidade"
  ], 0, ""),

  // 2 MSF – para que serve
  q("O MSF é usado para, entre outros, determinar:", [
    "Se é necessária formação e qual a formação necessária",
    "A nota mínima para aprovação automática",
    "O salário do formador",
    "A carga fiscal da instituição"
  ], 0, ""),

  // 3 Situações de uso do MSF
  q("O MSF é aplicado quando existem necessidades:", [
    "De formação, liderança e organizacionais",
    "Apenas de formação técnica",
    "Exclusivamente de recursos materiais",
    "Somente de avaliação externa"
  ], 0, ""),

  // 4 Fases do MSF (macro)
  q("As fases do MSF incluem:", [
    "Análise, Projeto, Desenvolvimento/Implementação e Avaliação",
    "Planeamento, Finanças, Marketing e Auditoria",
    "Recrutamento, Seleção, Integração e Carreira",
    "Exploração, Negociação, Aquisição e Alienação"
  ], 0, ""),

  // 5 DN – o que faz
  q("Na fase de Análise/Diagnóstico de Necessidades (DN) destaca-se:", [
    "Verificar necessidades e elaborar o referencial de competências",
    "Redigir o Plano Guia de Sessão",
    "Atribuir códigos e horas no DTP",
    "Emitir certificados e ECTS"
  ], 0, ""),

  // 6 Projeto – RF e população-alvo
  q("Na fase de Projeto inclui-se:", [
    "Definir população-alvo e o Referencial de Formação",
    "Apenas compra de recursos audiovisuais",
    "Exclusivamente a redação de testes",
    "A calendarização de férias"
  ], 0, ""),

  // 7 Desenvolvimento/Implementação – exemplos
  q("No Desenvolvimento e Implementação incluem-se, entre outros:", [
    "Horários, Planos-Guia de Sessão e Recursos",
    "Apenas avaliação sumativa",
    "Exclusivamente contratação de formadores",
    "Somente auditorias financeiras"
  ], 0, ""),

  // 8 DTP
  q("O Dossier Técnico-Pedagógico (DTP) é elaborado sobretudo na fase de:", [
    "Desenvolvimento e Implementação",
    "Análise",
    "Avaliação",
    "Recrutamento"
  ], 0, ""),

  // 9 Kirkpatrick – níveis
  q("O modelo de avaliação de Kirkpatrick compreende:", [
    "Reação, Aprendizagem, Transferência e Impacto",
    "Planeamento, Execução, Controlo e Encerramento",
    "Conhecimentos, Aptidões, Atitudes e Valores",
    "Diagnóstico, Desenho, Desenvolvimento e Disseminação"
  ], 0, ""),

  // 10 Nível 1
  q("No nível 1 de Kirkpatrick avalia-se principalmente:", [
    "Reação/satisfação dos formandos",
    "Transferência para o posto de trabalho",
    "Impacto organizacional",
    "Custo-benefício a 5 anos"
  ], 0, ""),

  // 11 Nível 2
  q("A avaliação da aprendizagem (Kirkpatrick Nível 2) incide em:", [
    "Conhecimentos e aptidões adquiridos",
    "Apenas motivação intrínseca",
    "Assiduidade",
    "Preferências por metodologias"
  ], 0, ""),

  // 12 Nível 3
  q("A transferência (Kirkpatrick Nível 3) mede:", [
    "Aplicação no contexto de trabalho",
    "Satisfação imediata",
    "Custos com formação",
    "Taxa de conclusão de e-learning"
  ], 0, ""),

  // 13 Nível 4
  q("O impacto (Kirkpatrick Nível 4) foca:", [
    "Resultados na organização",
    "Pontualidade dos formandos",
    "Número de slides por sessão",
    "Preferência por coffee-break"
  ], 0, ""),

  // 14 Bolonha – prioridades
  q("Entre as prioridades da Declaração de Bolonha (1999) incluem-se:", [
    "Mobilidade, Empregabilidade e Qualidade",
    "Segurança, Defesa e Justiça",
    "Fiscalidade, Câmbio e Balança de Pagamentos",
    "Turismo, Ambiente e Agricultura"
  ], 0, ""),

  // 15 Bolonha – objetivo exemplo
  q("Um objetivo central de Bolonha é:", [
    "Criar um sistema comparável de graus e adotar créditos (ECTS)",
    "Eliminar graus académicos",
    "Substituir toda a formação presencial por online",
    "Extinguir a avaliação externa"
  ], 0, ""),

  // 16 Copenhaga – prioridades
  q("A Declaração de Copenhaga (EFP, 2002) foca entre outros:", [
    "Inclusão social, coesão, mobilidade, empregabilidade e competitividade",
    "Apenas mobilidade estudantil universitária",
    "Somente harmonização fiscal",
    "Exclusivamente certificação privada"
  ], 0, ""),

  // 17 Copenhaga – objetivos
  q("Entre os objetivos de Copenhaga está:", [
    "Transparência/comparabilidade e reconhecimento de competências/qualificações",
    "Abolir a formação dual",
    "Uniformizar salários",
    "Centralizar toda a educação em Bruxelas"
  ], 0, ""),

  // 18 QEQ – estrutura
  q("O Quadro Europeu de Qualificações (QEQ) organiza resultados de aprendizagem por:", [
    "Conhecimentos, Aptidões e Atitudes/Competências",
    "Objetivos, Conteúdos e Recursos",
    "Teoria, Prática e Estágio",
    "Horas, Créditos e Avaliação"
  ], 0, ""),

  // 19 Qualificação – definição
  q("‘Qualificação’ significa:", [
    "Resultado formal de avaliação/validação reconhecido por entidade competente",
    "Somente um diploma de ensino secundário",
    "Apenas um certificado de frequência",
    "Um cargo hierárquico"
  ], 0, ""),

  // 20 SNQ
  q("O Sistema Nacional de Qualificações (SNQ) articula:", [
    "Educação/formação com mercado de trabalho e sociedade civil",
    "Apenas universidades públicas",
    "Somente cursos ECTS",
    "Exclusivamente formação informal"
  ], 0, ""),

  // 21 QNQ
  q("O Quadro Nacional de Qualificações (QNQ) está estruturado em:", [
    "8 níveis, por ordem crescente",
    "3 ciclos de estudos apenas",
    "5 categorias funcionais",
    "2 níveis por setor"
  ], 0, ""),

  // 22 Tipos de formação
  q("Formação ‘não formal’ e ‘informal’ são respetivamente:", [
    "Estruturada (ex.: na empresa) e não estruturada (aprendizagem no dia-a-dia)",
    "Ambas obrigatórias em contexto escolar",
    "Exclusivamente online",
    "Sinónimos sem distinção"
  ], 0, ""),

  // 23 Abordagem por competências
  q("A abordagem por competências é tipicamente:", [
    "Focada no formando, nos resultados e na lógica holística (KSC)",
    "Centrada na duração e nos conteúdos",
    "Dependente apenas de aula expositiva",
    "Sem relação com desempenho"
  ], 0, ""),

  // 24 Benefícios do QEQ
  q("Um benefício do QEQ é:", [
    "Facilitar comparação e transferência de qualificações entre países/sistemas",
    "Eliminar a necessidade de avaliação",
    "Homogeneizar todos os currículos",
    "Extinguir formações locais"
  ], 0, ""),

  // 25 DACUM – definição
  q("A Matriz DACUM é:", [
    "Um quadro de análise ocupacional para discriminar informação necessária à tarefa",
    "Um horário semanal",
    "Um contrato de trabalho",
    "Uma folha de presença"
  ], 0, ""),

  // 26 DACUM – elementos
  q("Uma DACUM (modelo de teste) inclui:", [
    "Procedimentos, Padrões de desempenho, Recursos externos e Conhecimentos",
    "Apenas horários e presenças",
    "Somente custos e faturas",
    "Exclusivamente bibliografia"
  ], 0, ""),

  // 27 Procedimentos – formulação
  q("Procedimentos devem ser redigidos como:", [
    "Verbo no infinitivo + objeto (+ condição)",
    "Verbo no gerúndio + objeto",
    "Substantivo + condição",
    "Adjetivo + advérbio"
  ], 0, ""),

  // 28 Padrões – conceito
  q("Padrões de desempenho são:", [
    "Critérios observáveis e mensuráveis que definem qualidade do desempenho",
    "Lista de recursos a usar",
    "Inventário de leis e artigos",
    "Plano de pagamento"
  ], 0, ""),

  // 29 Padrões – requisitos
  q("Entre os requisitos dos padrões estão:", [
    "Quantidade, Tempo, Precisão e Realismo",
    "Preço, Marca, Garantia e Cor",
    "Autor, Edição, ISBN e Título",
    "Custo, Receita, Margem e IVA"
  ], 0, ""),

  // 30 Padrões – formulação
  q("A regra de formulação de padrões é:", [
    "Verbo no gerúndio + objeto + condição",
    "Verbo no infinitivo + objeto",
    "Substantivo + condição",
    "Verbo no passado + advérbio"
  ], 0, ""),

  // 31 Tarefa – características
  q("Uma ‘tarefa’ deve ser:", [
    "Observável/mensurável, com princípio e fim, executada por uma pessoa",
    "Dependente de várias tarefas e não mensurável",
    "Apenas teórica e coletiva",
    "Sem necessidade de supervisão"
  ], 0, ""),

  // 32 Tarefa – formulação
  q("Na formulação de tarefas:", [
    "Usa-se uma ação por frase, na afirmativa, em sequência (planear, executar, avaliar)",
    "Devem incluir sempre três verbos por linha",
    "Inicia-se por advérbios",
    "Implicam sempre dois executantes"
  ], 0, ""),

  // 33 Recursos externos – pergunta-guia
  q("Recursos externos respondem a:", [
    "‘Que recursos são necessários para executar o procedimento?’",
    "‘Quem paga a formação?’",
    "‘Qual o estilo do formador?’",
    "‘Quantos formandos por turma?’"
  ], 0, ""),

  // 34 Recursos – formulação
  q("Regra de redação dos recursos externos:", [
    "Substantivo + condição (evitar identificar leis/artigos específicos)",
    "Verbo no gerúndio + objeto",
    "Parágrafos descritivos longos",
    "Citar diplomas por número/artigo"
  ], 0, ""),

  // 35 Conhecimentos – conceito
  q("Em ‘Conhecimentos’, descreve-se:", [
    "O acervo de factos, princípios, teorias e práticas a saber/saber-fazer",
    "Apenas as atitudes em contexto",
    "Somente recursos materiais",
    "O cronograma da sessão"
  ], 0, ""),

  // 36 Conhecimentos – relação
  q("Os conhecimentos devem:", [
    "Responder aos padrões de desempenho listados",
    "Ser independentes dos padrões",
    "Listar leis com número e artigo",
    "Conter apenas bibliografia"
  ], 0, ""),

  // 37 Conhecimentos – formulação
  q("Um modo correto de redigir conhecimentos é:", [
    "‘Ter conhecimentos de …’ / ‘Saber aplicar …’ / ‘Dominar …’",
    "‘Achar que …’ / ‘Opinar que …’",
    "Somente verbos no passado",
    "Usar frases com trocadilhos"
  ], 0, ""),

  // 38 Competências-chave
  q("Competências-chave são:", [
    "Aptidões/qualidades/conhecimentos transferíveis; base das técnicas",
    "Somente competências técnicas de posto",
    "Apenas soft skills emocionais",
    "Exclusivamente línguas estrangeiras"
  ], 0, ""),

  // 39 OA – definição (nota geral)
  q("Objetivos de aprendizagem (OA) descrevem o que:", [
    "O formando deve aprender (saber, saber-fazer, saber-ser)",
    "O formador pretende ensinar em abstrato",
    "A instituição cobra ao formando",
    "A turma decide por maioria"
  ], 0, ""),

  // 40 OA – características
  q("Entre as características dos OA estão:", [
    "Exequíveis, relevantes, avaliáveis e específicos",
    "Vagos e genéricos",
    "Sem relação com o posto de trabalho",
    "Não exigem avaliação"
  ], 0, ""),

  // 41 OA – estrutura geral
  q("A estrutura típica dos OA inclui:", [
    "Tarefa (verbo no infinitivo + objeto), condição e nível/critério",
    "Apenas condição",
    "Somente nível",
    "Verbo no gerúndio e adjetivos"
  ], 0, ""),

  // 42 PGS
  q("O Plano-Guia de Sessão (PGS) serve para:", [
    "Estruturar a aula do formador (objetivos, métodos, conteúdos, recursos, tempo)",
    "Registar assiduidade",
    "Emitir certificados",
    "Controlar orçamento"
  ], 0, ""),

  // 43 RF – conteúdos
  q("No Referencial de Formação, os ‘Conteúdos’ derivam:", [
    "Dos procedimentos (convertidos em substantivos/expressões nominais)",
    "Dos recursos externos",
    "De preferências dos formandos",
    "De legislação citada por artigo"
  ], 0, ""),

  // 44 RF – recursos didáticos
  q("‘Recursos Didáticos’ no RF combinam:", [
    "Recursos externos + meios de sala (projetor, quadro, PC...)",
    "Apenas bibliografia",
    "Somente legislação numerada",
    "Exclusivamente equipamentos operacionais"
  ], 0, ""),

  // 45 Tarefa – verbo e objeto
  q("Uma tarefa deve conter:", [
    "Um verbo de ação e um objeto",
    "Apenas um substantivo",
    "Dois verbos e dois objetos",
    "Somente adjetivos"
  ], 0, ""),

  // 46 Padrões – evitar
  q("Na formulação de padrões de desempenho deve-se evitar:", [
    "Adjetivos vagos (ex.: ‘bom’, ‘correto’)",
    "Gerúndio",
    "Referência a condição",
    "Clareza e precisão"
  ], 0, ""),

  // 47 Recursos – categorias
  q("Recursos externos podem incluir:", [
    "Equipamento, ferramentas, métodos/processos, expediente, legislação, viaturas",
    "Apenas vencimentos e abonos",
    "Exclusivamente formulários financeiros",
    "Somente bibliografia internacional"
  ], 0, ""),

  // 48 Abordagem por competências – KSC
  q("Na abordagem por competências, ‘KSC’ significa:", [
    "Knowledge, Skills, Competence (Conhecimentos, Aptidões, Competências/Atitudes)",
    "Key, Standard, Criteria",
    "Know-how, Schedule, Cost",
    "Keep, Save, Control"
  ], 0, ""),

  // 49 Itens a dominar (nota do teste)
  q("Segundo o formato do teste, poderás ser chamado a elaborar:", [
    "Procedimentos, Padrões, Recursos e Conhecimentos, e um Referencial de Formação",
    "Somente bibliografia comentada",
    "Apenas um PGS",
    "Exclusivamente um relatório financeiro"
  ], 0, ""),

  // 50 Tarefa – sequência P-E-A
  q("A sequência recomendada para descrever procedimentos é:", [
    "Planear, Executar e Avaliar",
    "Conceber, Vender e Entregar",
    "Recrutar, Selecionar e Pagar",
    "Observar, Opinar e Improvisar"
  ], 0, "")
];

/* ---------- Construção/execução ---------- */
function build(testId){
  CURRENT.testId = testId;
  const base = (testId==='54') ? TEST_54 : (testId==='55') ? TEST_55 : TEST_CDF;

  const seed = uid();
  CURRENT.seed = seed;

  // Baralha perguntas e opções; limita a 30 por tentativa
  const items = shuffle(base).map((q,i)=>{
    const idxMap = [0,1,2,3];
    const shuffledIdxs = shuffle(idxMap);
    const opts = shuffledIdxs.map(k=>q.options[k]);
    const correct = shuffledIdxs.indexOf(q.correctIndex);
    return {
      id:`${testId}-${i+1}`,
      stem:q.stem,
      opts:opts,
      correct:correct,
      explanation:q.explanation||''
    };
  });

  CURRENT.items = items.slice(0,30);
  CURRENT.answers = {};
  CURRENT.key = Object.fromEntries(CURRENT.items.map(it=>[it.id, it.correct]));
  CURRENT.locked = false;
  CURRENT.evaluated = false;
  render();
  localStorage.removeItem(storageKey()); // novo baralhamento → limpa antigas
  updateCounts();
}

function render(){
  $quiz.innerHTML = '';
  CURRENT.items.forEach((q, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'q';
    wrap.dataset.qid = q.id;
    const h = document.createElement('h3');
    h.innerHTML = `<span class="muted">Q${idx+1}.</span> ${q.stem}`;
    const opts = document.createElement('div');
    opts.className = 'opts';
    q.opts.forEach((opt, i)=>{
      const id = `${q.id}-o${i}`;
      const line = document.createElement('label');
      line.className = 'opt';
      line.innerHTML = `
        <input type="radio" name="${q.id}" id="${id}" value="${i}">
        <div>${opt}</div>
      `;
      opts.appendChild(line);
    });
    wrap.appendChild(h);
    wrap.appendChild(opts);
    $quiz.appendChild(wrap);
  });

  $state.textContent = 'Em resposta';
  $score.textContent = '–';
  $cRight.textContent = '0';
  $cWrong.textContent = '0';
  $cBlank.textContent = String(30);
  $export.disabled = true;

  $quiz.addEventListener('change', onSelect, { once:false, passive:true });
}

function onSelect(e){
  if(!e.target || e.target.type!=='radio') return;
  if(CURRENT.locked) return;
  const name = e.target.name; // qid
  const val = Number(e.target.value);
  CURRENT.answers[name] = val;
  saveState();
  updateCounts();
}

function updateCounts(){
  const answered = Object.keys(CURRENT.answers).length;
  $prog.textContent = `${answered}/30`;
  $cBlank.textContent = String(30-answered);
}

function evaluate(){
  CURRENT.locked = true;
  CURRENT.evaluated = true;
  $state.textContent = 'Corrigido';
  let right=0, wrong=0;
  document.querySelectorAll('.q').forEach(qEl=>{
    const qid = qEl.dataset.qid;
    const item = CURRENT.items.find(x=>x.id===qid);
    const chosen = CURRENT.answers[qid];
    const correct = item.correct;

    const labels = qEl.querySelectorAll('.opt');
    labels.forEach((lab, i)=>{
      const input = lab.querySelector('input');
      input.disabled = true;
      if(i===correct){
        lab.classList.add('ok');
        lab.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--good');
      }
      if(chosen!==undefined){
        if(i===chosen && chosen!==correct){
          lab.classList.add('ko');
          lab.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--bad');
        }
      }
    });

    let badge = document.createElement('span');
    badge.className = 'badge ' + (chosen===correct ? 'ok' : 'ko');
    badge.textContent = (chosen===correct ? 'Correto' : (chosen===undefined ? 'Em branco' : 'Incorreto'));
    qEl.querySelector('h3').appendChild(document.createTextNode(' '));
    qEl.querySelector('h3').appendChild(badge);

    const exp = document.createElement('div');
    exp.className = 'explain';
    const correctTxt = item.opts[correct];
    if(chosen===correct){ right++; }
    else if(chosen===undefined){ /* blank */ }
    else { wrong++; }
    exp.innerHTML = `<strong>Resposta correta:</strong> ${correctTxt}${item.explanation ? ` — <em>${item.explanation}</em>`:''}`;
    qEl.appendChild(exp);
  });

  const blanks = 30 - (right + wrong);
  const note20 = (right/30)*20;
  $cRight.textContent = String(right);
  $cWrong.textContent = String(wrong);
  $cBlank.textContent = String(blanks);
  $score.textContent = note20.toFixed(1);
  $export.disabled = false;
  saveState();
}

function exportTxt(){
  const lines = [];
  lines.push(`Teste ${CURRENT.testId} — Resultados`);
  lines.push(`Certas: ${$cRight.textContent}`);
  lines.push(`Erradas: ${$cWrong.textContent}`);
  lines.push(`Em branco: ${$cBlank.textContent}`);
  lines.push(`Nota (/20): ${$score.textContent}`);
  lines.push('');
  CURRENT.items.forEach((it, i)=>{
    const chosen = CURRENT.answers[it.id];
    const mark = (chosen===undefined) ? '—' : String.fromCharCode(65+chosen);
    const ok = String.fromCharCode(65+it.correct);
    lines.push(`Q${i+1}. ${it.stem}`);
    it.opts.forEach((op, idx)=>{
      const tag = String.fromCharCode(65+idx);
      const sel = (idx===chosen)?'*':' ';
      const cor = (idx===it.correct)?' (correta)':'';
      lines.push(`  ${sel} ${tag}) ${op}${cor}`);
    });
    lines.push(`  → Tua resposta: ${mark} | Correta: ${ok}`);
    if(it.explanation) lines.push(`  Obs.: ${it.explanation}`);
    lines.push('');
  });
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `resultado_teste_${CURRENT.testId}.txt`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function clearProgress(){
  localStorage.removeItem(storageKey());
  build($sel.value);
}

/* ---------- Controlos UI ---------- */
$start.addEventListener('click', ()=>build($sel.value));
$submit.addEventListener('click', ()=>{
  const answered = Object.keys(CURRENT.answers).length;
  if(answered<30){
    const remain = 30-answered;
    if(!confirm(`Tens ${remain} pergunta(s) por responder. Queres entregar na mesma?`)){ return; }
  }
  evaluate();
});
$export.addEventListener('click', exportTxt);
$clear.addEventListener('click', clearProgress);
$sel.addEventListener('change', ()=>build($sel.value));

/* Arranque inicial */
build($sel.value);
</script>
</body>
</html>
