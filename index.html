<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Treino — Bastão Extensível (54.º/55.º)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --mute:#94a3b8; --acc:#22d3ee; --good:#22c55e; --bad:#ef4444;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,#0b1220 0,#0b1220ee 70%,#0b1220cc 100%),radial-gradient(1100px 500px at 110% -10%,#1f2937 0,#0b1220 60%);border:1px solid #1f2937;border-radius:18px;padding:20px 18px;box-shadow:0 10px 30px #0006}
  h1{font-size:1.6rem;margin:0 0 6px}
  .sub{color:var(--mute);margin:0 0 18px}
  select,button{font:inherit;color:var(--ink);background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
  select:focus,button:focus{outline:2px solid var(--acc);outline-offset:2px}
  button.primary{background:#0b1220;border-color:#334155}
  button.primary:hover{border-color:#475569}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;gap:10px;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:8px 12px;font-size:.95rem;color:var(--mute)}
  .q{margin:14px 0 18px;padding:16px;border:1px solid #1f2937;border-radius:14px;background:#0b1220b3}
  .q h3{font-size:1rem;margin:0 0 10px}
  .opts{display:grid;gap:8px}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid #1f2937;border-radius:10px;background:#0b1220}
  .opt input{margin-top:3px;accent-color:var(--acc)}
  .disabled{pointer-events:none;opacity:.8}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;font-size:.8rem}
  .ok{background:color-mix(in srgb, var(--good) 20%, transparent);border:1px solid var(--good);color:#bbf7d0}
  .ko{background:color-mix(in srgb, var(--bad) 15%, transparent);border:1px solid var(--bad);color:#fecaca}
  .explain{color:var(--mute);margin-top:8px;font-size:.94rem}
  .sticky{position:sticky;top:0;z-index:3;background:linear-gradient(#0f172a,#0f172aCC 80%,transparent);padding:10px 0 6px;margin:-10px 0 10px}
  .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-top:16px}
  .counts{display:flex;gap:8px;flex-wrap:wrap}
  .k{border:1px solid #1f2937;border-radius:10px;padding:6px 10px;color:var(--mute)}
  .score{font-weight:700}
  .muted{color:var(--mute)}
  .warning{border-left:4px solid #f59e0b;padding:10px 12px;border-radius:8px;background:#0b1220;margin:10px 0;color:#fde68a}
  @media (prefers-reduced-motion:no-preference){
    .q{transition:transform .15s ease, background .2s ease}
    .q:hover{transform:translateY(-1px)}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Quiz — Bastão Extensível (CFG 54.º / 55.º)</h1>
    <p class="sub">30 perguntas de escolha múltipla. Seleciona o teste, responde e só no final verás a correção e a nota (0–20).</p>
    <div class="row" style="margin-bottom:12px">
      <label for="testSel" class="pill">Escolher teste:
        <select id="testSel" style="margin-left:8px">
          <option value="54">54.º Curso</option>
          <option value="55">55.º Curso</option>
        </select>
      </label>
      <button id="startBtn" class="primary">Começar / Reiniciar</button>
      <span class="pill">Progresso: <span id="prog">0/30</span></span>
      <span class="pill">Estado: <span id="state">Em resposta</span></span>
    </div>

    <div id="quizArea"></div>

    <div class="sticky">
      <div class="footer">
        <div class="counts">
          <span class="k">Certas: <strong id="cRight">0</strong></span>
          <span class="k">Erradas: <strong id="cWrong">0</strong></span>
          <span class="k">Em branco: <strong id="cBlank">30</strong></span>
          <span class="k score">Nota (/20): <strong id="score">–</strong></span>
        </div>
        <div class="row">
          <button id="submitBtn" class="primary">Entregar</button>
          <button id="exportBtn" title="Exportar resultados para .txt" disabled>Exportar .txt</button>
          <button id="clearBtn" title="Limpar progresso">Limpar</button>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:8px">Baralha perguntas e opções a cada início. Progresso guardado localmente (por teste).</p>
  </div>
</div>

<script>
/* ---------- Banco de perguntas (54.º e 55.º) ----------
   Baseado no teu resumo/itens dos testes (54/55). Cada entrada: {stem, options[4], correct}
   Nota: algumas formulações são equivalentes entre 54 e 55 e foram normalizadas. */

const TEST_54 = [
  // 1
  q("As sete componentes da potência são:", [
    "Equilíbrio, flexibilidade, coordenação, resistência, simplicidade, velocidade, força",
    "Coordenação, potência, rotatividade, simplicidade, velocidade, força, foco",
    "Equilíbrio, precisão, coordenação, resistência, simplicidade, velocidade, força",
    "Equilíbrio, flexibilidade, coordenação, resistência, complexidade, velocidade, força"
  ], 0, "O resumo enumera 7: equilíbrio, flexibilidade, coordenação, resistência, simplicidade, velocidade e força."),
  // 2
  q("A intervenção policial em equipa destaca-se por permitir:", [
    "Atuar simultaneamente em diferentes patamares do uso da força",
    "Reduzir a necessidade de comunicação entre militares",
    "Substituir os princípios da mínima força",
    "Eliminar a necessidade de avaliação do risco"
  ], 0, "O trabalho em equipa permite operar em diferentes patamares do uso da força."),
  // 3
  q("O triângulo da decisão integra as variáveis:", [
    "Habilidade, Oportunidade e Risco",
    "Legalidade, Necessidade e Proporcionalidade",
    "Tempo, Distância e Cobertura",
    "Força, Velocidade e Resistência"
  ], 0, "Ferramenta de apoio com Habilidade, Oportunidade e Risco."),
  // 4
  q("A posição policial assenta em quatro componentes:", [
    "Estabilidade lateral e frontal, centro de gravidade baixo e cabeça ao centro",
    "Estabilidade frontal, cabeça baixa, pés paralelos e olhar no solo",
    "Base estreita, tronco à frente, cabeça baixa e braços estendidos",
    "Estabilidade lateral, base alta, braços cruzados e olhar fixo"
  ], 0, "Estabilidade frontal e lateral, centro de gravidade baixo, cabeça ao centro."),
  // 5
  q("O uso da força, com proporcionalidade e mínima força, pode ser entendido como:", [
    "Uma opção do ADV, face à advertência efetuada pelos militares",
    "Um automatismo do militar perante qualquer resistência",
    "Uma decisão exclusiva do comandante de patrulha",
    "Uma consequência inevitável do primeiro contacto"
  ], 0, "O ADV escolhe resistir após advertência; o militar aplica mínima força."),
  // 6
  q("No modo fechado, a técnica de controlo que não pode ser executada de ambos os lados do ADV é:", [
    "Controlo ao tríceps",
    "Controlo ao bíceps",
    "Controlo ao pulso",
    "Chave"
  ], 0, "Controlo ao tríceps é assimétrico no modo fechado."),
  // 7
  q("Segundo o Regime Geral das Armas e Munições, o BE é uma arma de:", [
    "Classe A",
    "Classe B",
    "Classe C",
    "Classe D"
  ], 0, "i) do n.º 2 do art. 3.º — arma de classe A."),
  // 8
  q("A abertura do BE “para baixo” executa-se quando:", [
    "O espaço é reduzido",
    "Se pretende máxima visibilidade",
    "O terreno é escorregadio",
    "Há vento lateral forte"
  ], 0, "No espaço reduzido privilegia-se a abertura para baixo."),
  // 9
  q("As técnicas de impacto em zonas amarelas são executadas:", [
    "Quando as técnicas nas zonas verdes se revelem ineficazes",
    "Como primeira opção em qualquer intervenção",
    "Apenas para dispersão de multidões",
    "Exclusivamente em treino"
  ], 0, "Priorizar verdes; amarelas quando verdes não forem eficazes."),
  // 10
  q("A técnica de Afastamento (modo fechado) com rotação do pulso executa-se:", [
    "Retirando o polegar da ponta e colocando-o por cima do indicador",
    "Unindo polegar ao médio para aumentar o aperto",
    "Colocando o polegar por baixo do indicador",
    "Girando apenas o punho da mão de defesa"
  ], 0, "Polegar abandona a ponta e fica sobre o indicador."),
  // 11
  q("O BE é utilizado para:", [
    "Controlar e deter um adversário",
    "Dispersar e dissuadir multidões",
    "Imobilizar permanentemente",
    "Assumir função idêntica à arma de fogo"
  ], 0, "BE destina-se a deter e/ou controlar; não para dispersar."),
  // 12
  q("Para executantes destros, o Direto (modo fechado) é executado:", [
    "Na diagonal, da direita para a esquerda",
    "Na horizontal, da esquerda para a direita",
    "De baixo para cima, vertical",
    "Em arco completo acima da cabeça"
  ], 0, "Diagonal direita→esquerda."),
  // 13
  q("A posição de intervenção foi concebida para:", [
    "Maximizar a disponibilidade do bastão e aumentar a postura defensiva",
    "Favorecer deslocamentos rápidos sacrificando estabilidade",
    "Aumentar o alcance do BE acima da cabeça",
    "Eliminar a necessidade da mão de defesa"
  ], 0, "Disponibilidade + postura defensiva."),
  // 14
  q("A componente mais essencial para a geração de potência é:", [
    "Equilíbrio",
    "Força",
    "Velocidade",
    "Resistência"
  ], 0, "Equilíbrio é a base da potência."),
  // 15
  q("A condição física influencia a intervenção porque:", [
    "Afeta o discernimento e a capacidade de decisão",
    "Substitui a técnica adequada",
    "Elimina o risco operacional",
    "Dispensa o trabalho em equipa"
  ], 0, "Boa condição física preserva discernimento e decisão."),
  // 16
  q("O BE e o bastão de borracha são:", [
    "Ferramentas diferentes que se complementam",
    "Intercambiáveis e com a mesma finalidade",
    "Ambos destinados a dispersão",
    "Ambos de uso discreto e rígido"
  ], 0, "Complementares; borracha para dispersar, BE para deter/controlo."),
  // 17
  q("O BE é constituído por:", [
    "Base, pega, guarda, corpo médio, corpo final e ponta",
    "Empunhadura, lâmina, guarda, corpo único",
    "Pega, mola, gatilho e ponta",
    "Cabo, corrente e peso terminal"
  ], 0, "Estrutura típica em três secções e componentes listados."),
  // 18
  q("Qual a posição policial que garante mais estabilidade ao utilizador do BE?", [
    "Posição de intervenção",
    "Posição de descanso",
    "Posição de corrida",
    "Posição de apresentação"
  ], 0, "Posição de intervenção maximiza estabilidade."),
  // 19
  q("Em modo aberto, as técnicas devem ser realizadas com:", [
    "Os últimos ~7 cm do corpo final e a ponta",
    "A base do bastão para obter mais massa",
    "A zona média do corpo médio",
    "Qualquer parte indistintamente"
  ], 0, "Concentrar potência no extremo (≈7 cm finais + ponta)."),
  // 20
  q("Legalmente, o BE é definido como:", [
    "Um instrumento portátil telescópico, rígido ou flexível",
    "Uma arma contundente de borracha",
    "Um artefacto pirotécnico de classe B",
    "Um dispositivo elétrico de choque"
  ], 0, "Definição legal: portátil, telescópico, rígido/flexível."),
  // 21
  q("O BE destina-se preferencialmente a atuar sobre:", [
    "Grandes massas musculares dos braços e pernas (inibição motora)",
    "Cabeça e pescoço para terminar mais rápido",
    "Coluna vertebral para desequilíbrio imediato",
    "Genitais para dissuasão"
  ], 0, "Zonas verdes: grandes grupos musculares."),
  // 22
  q("Os locais para onde NÃO se devem dirigir técnicas de impacto com BE incluem:", [
    "Cabeça, pescoço, externo, coluna vertebral e genitais",
    "Braços e coxas",
    "Antebraços e gémeos",
    "Quadríceps e deltoides"
  ], 0, "Zonas vermelhas pelo risco de lesões graves."),
  // 23
  q("A distância de segurança serve sobretudo para:", [
    "Controlar o impulso do ADV",
    "Permitir sempre a fuga do ADV",
    "Evitar quaisquer técnicas de controlo",
    "Garantir a abertura para cima"
  ], 0, "Controla o avanço/impulso do adversário."),
  // 24
  q("Abertura e fecho do BE são executados, respetivamente, por:", [
    "Inércia e fricção",
    "Fricção e inércia",
    "Compressão e fricção",
    "Inércia e compressão"
  ], 0, "Abre por inércia, fecha por fricção."),
  // 25
  q("As caraterísticas de uma boa funda para o BE são:", [
    "Rígida, rotativa e adaptável",
    "Flexível, fixa e não ajustável",
    "Rígida, fechada e não rotativa",
    "Maleável, elástica e solta"
  ], 0, "Facilita transporte, extração e ajuste no cinto."),
  // 26
  q("Em caso de espaço amplo e necessidade de visibilidade, a abertura recomendada é:", [
    "Para cima (máxima visibilidade)",
    "Para baixo (para não denunciar movimento)",
    "Horizontal (a 90°)",
    "Não abrir — manter fechado"
  ], 0, "Abertura para cima maximiza a visibilidade."),
  // 27
  q("As técnicas com BE foram concebidas para atuar:", [
    "No centro de massa de braços e pernas",
    "Preferencialmente na cabeça e pescoço",
    "No tronco superior e cervical",
    "Nos tornozelos e mãos"
  ], 0, "Centro de massa dos membros."),
  // 28
  q("A flexibilidade está diretamente relacionada com:", [
    "Tensão, nervosismo e falta de confiança",
    "Força máxima voluntária",
    "Envergadura e estatura",
    "Peso do equipamento"
  ], 0, "Rigidez + tensão/nervosismo prejudicam a intervenção."),
  // 29
  q("Trabalhar em equipa permite:", [
    "Aplicar diferentes patamares do uso da força de forma coordenada",
    "Eliminar a necessidade de avaliação de risco",
    "Dispensar a distância de segurança",
    "Reduzir a comunicação para evitar ruído"
  ], 0, "Equipa = patamares diferentes, coordenados."),
  // 30
  q("Zonas amarelas destinam-se sobretudo a:", [
    "Técnicas de controlo/imobilização (articulações)",
    "Impacto inicial preferencial",
    "Dissuadir à distância",
    "Aplicar pressão contínua em músculos"
  ], 0, "Verdes para impacto; amarelas para controlo/imobilização.")
];

const TEST_55 = [
  // 1
  q("A abertura do BE “para baixo” executa-se quando:", [
    "O espaço é reduzido",
    "Se pretende o máximo impacto psicológico",
    "O terreno é macio",
    "Há necessidade de luz"
  ], 0, "Espaço reduzido → abertura para baixo."),
  // 2
  q("Abertura e fecho do BE são executados por:", [
    "Inércia e fricção",
    "Fricção e inércia",
    "Compressão e mola",
    "Alavanca e mola"
  ], 0, "Abre por inércia, fecha por fricção."),
  // 3
  q("Uso da força (proporcionalidade/mínima força) pode ser entendido como:", [
    "Uma opção do ADV, face à advertência efetuada",
    "Um automatismo sempre que exista ilícito",
    "Uma decisão apenas do superior hierárquico",
    "Uma resposta padronizada e fixa"
  ], 0, "Após advertência, o ADV escolhe resistir."),
  // 4
  q("Componente essencial para geração de potência:", [
    "Equilíbrio",
    "Força",
    "Velocidade",
    "Resistência"
  ], 0, "Equilíbrio > restantes."),
  // 5
  q("Impacto com BE atua sobre:", [
    "Sistema motor",
    "Sistema respiratório",
    "Sistema circulatório",
    "Sistema digestivo"
  ], 0, "Visa inibição motora."),
  // 6
  q("Sete componentes de potência:", [
    "Equilíbrio, flexibilidade, coordenação, resistência, simplicidade, velocidade, força",
    "Equilíbrio, flexibilidade, coordenação, potência, velocidade, força, foco",
    "Resistência, elasticidade, coordenação, simplicidade, velocidade, força, foco",
    "Equilíbrio, precisão, coordenação, resistência, simplicidade, velocidade, força"
  ], 0, "Lista completa, incluindo simplicidade."),
  // 7
  q("Afastamento (modo fechado) com rotação do pulso:", [
    "Polegar abandona a ponta e fica por cima do indicador",
    "Polegar fixa a ponta por baixo do indicador",
    "Polegar permanece na ponta",
    "Polegar roda para a palma"
  ], 0, "Polegar sobre o indicador."),
  // 8
  q("Controlo em modo fechado que não pode ser feito de ambos os lados:", [
    "Controlo ao tríceps",
    "Controlo ao bíceps",
    "Controlo ao pulso",
    "Chave"
  ], 0, "Tríceps (assimétrico em fechado)."),
  // 9
  q("Técnica de Reação (modo fechado) é executada quando:", [
    "O Direto anterior não foi eficaz",
    "Há dois ADV em simultâneo",
    "Para iniciar qualquer intervenção",
    "Quando o ADV está imobilizado"
  ], 0, "No fechado: reação após direto falhar."),
  // 10
  q("Segundo o RGAM, o BE é arma de:", [
    "Classe A",
    "Classe B",
    "Classe C",
    "Classe D"
  ], 0, "Classe A."),
  // 11
  q("A flexibilidade está relacionada com:", [
    "Tensão, nervosismo e falta de confiança",
    "Força absoluta",
    "Velocidade de reação",
    "Amplitude de movimento apenas"
  ], 0, "É afetada por tensão/nervosismo; melhora com treino."),
  // 12
  q("Triângulo da decisão:", [
    "Habilidade, oportunidade e risco",
    "Tempo, distância e cobertura",
    "Legalidade, necessidade e adequação",
    "Força, velocidade e resistência"
  ], 0, "HOR."),
  // 13
  q("Características de uma boa funda para BE:", [
    "Rígida, rotativa e adaptável",
    "Flexível, elástica e não ajustável",
    "Fina, leve e descartável",
    "Rígida, fixa e não rotativa"
  ], 0, "Rígida/rotativa/adaptável."),
  // 14
  q("Direto (modo fechado) para destros:", [
    "Diagonal da direita para a esquerda",
    "Horizontal da esquerda para a direita",
    "Vertical ascendente",
    "Arco por cima da cabeça"
  ], 0, "Diagonal D→E."),
  // 15
  q("A posição de intervenção foi concebida para:", [
    "Maximizar disponibilidade do bastão e postura defensiva",
    "Aumentar a velocidade de corrida",
    "Facilitar técnicas acima da cabeça",
    "Dispensar a mão de defesa"
  ], 0, "Disponibilidade + defesa."),
  // 16
  q("Intervenção em equipa destaca-se por permitir:", [
    "Atuar em diferentes patamares do uso da força",
    "Eliminar avaliação de risco",
    "Evitar comunicações",
    "Substituir legalidade por eficácia"
  ], 0, "Patamares diferentes, coordenados."),
  // 17
  q("Posição policial assenta em:", [
    "Estabilidade lateral e frontal, centro de gravidade baixo e cabeça ao centro",
    "Base estreita, tronco à frente, cabeça baixa e braços estendidos",
    "Estabilidade frontal, cabeça baixa, pés paralelos e olhar no solo",
    "Estabilidade lateral, base alta, braços cruzados e olhar fixo"
  ], 0, "Quatro componentes chave."),
  // 18
  q("Zonas a evitar para impacto com BE:", [
    "Cabeça, pescoço, externo, coluna e genitais",
    "Braços e coxas",
    "Antebraços e gémeos",
    "Deltoides e quadríceps"
  ], 0, "Zonas vermelhas."),
  // 19
  q("A distância de segurança permite:", [
    "Controlar o impulso do ADV",
    "Eliminar a necessidade de BE",
    "Aplicar pressão contínua",
    "Garantir mobilidade do ADV"
  ], 0, "Gestão do avanço do adversário."),
  // 20
  q("BE vs bastão de borracha:", [
    "Ferramentas diferentes que se complementam",
    "Igual finalidade e uso",
    "Ambos para dispersão",
    "Ambos flexíveis"
  ], 0, "Complementares; objetivos distintos."),
  // 21
  q("Constituição do BE:", [
    "Base, pega, guarda, corpo médio, corpo final e ponta",
    "Empunhadura, lâmina, guarda e corpo",
    "Cabo, corrente e peso terminal",
    "Pega, mola, gatilho e ponta"
  ], 0, "Componentes listados."),
  // 22
  q("Posição policial que garante mais estabilidade:", [
    "Posição de intervenção",
    "Posição de descanso",
    "Posição de apresentação",
    "Posição de avanço"
  ], 0, "Intervenção."),
  // 23
  q("Em modo aberto, as técnicas devem usar preferencialmente:", [
    "Últimos ~7 cm do corpo final e a ponta",
    "A base do bastão",
    "A zona média",
    "Qualquer parte"
  ], 0, "Extremo distal concentra potência."),
  // 24
  q("Definição legal do BE:", [
    "Instrumento portátil telescópico, rígido ou flexível",
    "Arma contundente de borracha",
    "Dispositivo elétrico",
    "Instrumento perfurante telescópico"
  ], 0, "Definição legal literal."),
  // 25
  q("O BE é utilizado para:", [
    "Controlar e deter um adversário",
    "Dispersar grupos",
    "Substituir algemas",
    "Atuar como arma elétrica"
  ], 0, "Detenção/controlo."),
  // 26
  q("Zonas amarelas são usadas quando:", [
    "As técnicas em zonas verdes se revelam ineficazes",
    "Se inicia a intervenção",
    "Há necessidade de dissuasão sonora",
    "O ADV está rendido"
  ], 0, "Prioridade verdes; amarelas se necessário."),
  // 27
  q("Abertura 'para cima' proporciona:", [
    "Máxima visibilidade",
    "Menor controlo do bastão",
    "Mais discrição sonora",
    "Acesso mais lento"
  ], 0, "Visibilidade máxima."),
  // 28
  q("As técnicas com BE são concebidas para atuar:", [
    "No centro de massa dos braços e pernas",
    "Preferencialmente na cabeça",
    "Maioritariamente no tronco",
    "Em mãos e pés apenas"
  ], 0, "Centro de massa dos membros."),
  // 29
  q("Características da funda devem ainda permitir:", [
    "Colocação e extração, inclusive com BE aberto",
    "Apenas uso com BE fechado",
    "Fixação frouxa ao cinturão",
    "Rotação impedida para segurança"
  ], 0, "Abertura no fundo/lateral facilita extração inclusive aberto."),
  // 30
  q("Comparação final: BE e bastão de borracha — objetivo principal do BE:", [
    "Deter e controlar (não dispersar)",
    "Dispersar com menor lesividade",
    "Atuar como substituto da arma de fogo",
    "Causar dor como objetivo principal"
  ], 0, "BE: deter/controlo; borracha: dispersar.")
];

// ---------- Utilidades ----------
function q(stem, options, correctIndex, explanation){
  return { stem, options, correctIndex, explanation };
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function uid(){ return Math.random().toString(36).slice(2) }

const el = (q)=>document.querySelector(q);
const $quiz = el('#quizArea');
const $prog = el('#prog');
const $state = el('#state');
const $score = el('#score');
const $cRight = el('#cRight');
const $cWrong = el('#cWrong');
const $cBlank = el('#cBlank');
const $submit = el('#submitBtn');
const $start = el('#startBtn');
const $export = el('#exportBtn');
const $clear = el('#clearBtn');
const $sel = el('#testSel');

let CURRENT = { testId:'54', items:[], answers:{}, key:{}, locked:false, evaluated:false, seed:'' };

function storageKey(){ return `be_quiz_${CURRENT.testId}`; }
function saveState(){
  const data = { answers:CURRENT.answers, seed:CURRENT.seed };
  localStorage.setItem(storageKey(), JSON.stringify(data));
}
function loadState(){
  const raw = localStorage.getItem(storageKey());
  if(!raw) return null;
  try { return JSON.parse(raw) } catch { return null }
}

function build(testId){
  CURRENT.testId = testId;
  const base = (testId==='54') ? TEST_54 : TEST_55;
  const seed = uid();
  CURRENT.seed = seed;
  const items = shuffle(base).map((q,i)=>{
    const idxMap = [0,1,2,3];
    const shuffledIdxs = shuffle(idxMap);
    const opts = shuffledIdxs.map(k=>q.options[k]);
    const correct = shuffledIdxs.indexOf(q.correctIndex);
    return {
      id:`${testId}-${i+1}`,
      stem:q.stem,
      opts:opts,
      correct:correct,
      explanation:q.explanation||''
    };
  });
  // mantém exatamente 30
  CURRENT.items = items.slice(0,30);
  CURRENT.answers = {};
  CURRENT.key = Object.fromEntries(CURRENT.items.map(it=>[it.id, it.correct]));
  CURRENT.locked = false;
  CURRENT.evaluated = false;
  render();
  const prev = loadState();
  if(prev && prev.seed){ // restaurar respostas só se mesma ordem (mesmo seed)
    // Como baralhamos sempre, evitamos confusão: só repõe se seed igual (não é) → limpa
    localStorage.removeItem(storageKey());
  }
  updateCounts();
}

function render(){
  $quiz.innerHTML = '';
  CURRENT.items.forEach((q, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'q';
    wrap.dataset.qid = q.id;
    const h = document.createElement('h3');
    h.innerHTML = `<span class="muted">Q${idx+1}.</span> ${q.stem}`;
    const opts = document.createElement('div');
    opts.className = 'opts';
    q.opts.forEach((opt, i)=>{
      const id = `${q.id}-o${i}`;
      const line = document.createElement('label');
      line.className = 'opt';
      line.innerHTML = `
        <input type="radio" name="${q.id}" id="${id}" value="${i}">
        <div>${opt}</div>
      `;
      opts.appendChild(line);
    });
    wrap.appendChild(h);
    wrap.appendChild(opts);
    $quiz.appendChild(wrap);
  });

  $state.textContent = 'Em resposta';
  $score.textContent = '–';
  $cRight.textContent = '0';
  $cWrong.textContent = '0';
  $cBlank.textContent = String(30);
  $export.disabled = true;

  // listeners
  $quiz.addEventListener('change', onSelect, { once:false, passive:true });
}

function onSelect(e){
  if(!e.target || e.target.type!=='radio') return;
  if(CURRENT.locked) return;
  const name = e.target.name; // qid
  const val = Number(e.target.value);
  CURRENT.answers[name] = val;
  saveState();
  updateCounts();
}

function updateCounts(){
  const answered = Object.keys(CURRENT.answers).length;
  $prog.textContent = `${answered}/30`;
  $cBlank.textContent = String(30-answered);
}

function evaluate(){
  CURRENT.locked = true;
  CURRENT.evaluated = true;
  $state.textContent = 'Corrigido';
  // marcar correto/errado e mostrar explicações
  let right=0, wrong=0;
  document.querySelectorAll('.q').forEach(qEl=>{
    const qid = qEl.dataset.qid;
    const item = CURRENT.items.find(x=>x.id===qid);
    const chosen = CURRENT.answers[qid];
    const correct = item.correct;

    const labels = qEl.querySelectorAll('.opt');
    labels.forEach((lab, i)=>{
      const input = lab.querySelector('input');
      input.disabled = true;
      if(i===correct){
        lab.classList.add('ok');
        lab.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--good');
      }
      if(chosen!==undefined){
        if(i===chosen && chosen!==correct){
          lab.classList.add('ko');
          lab.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--bad');
        }
      }
    });

    let badge = document.createElement('span');
    badge.className = 'badge ' + (chosen===correct ? 'ok' : 'ko');
    badge.textContent = (chosen===correct ? 'Correto' : (chosen===undefined ? 'Em branco' : 'Incorreto'));
    qEl.querySelector('h3').appendChild(document.createTextNode(' '));
    qEl.querySelector('h3').appendChild(badge);

    const exp = document.createElement('div');
    exp.className = 'explain';
    const correctTxt = item.opts[correct];
    if(chosen===correct){ right++; }
    else if(chosen===undefined){ /* blank */ }
    else { wrong++; }
    exp.innerHTML = `<strong>Resposta correta:</strong> ${correctTxt}${item.explanation ? ` — <em>${item.explanation}</em>`:''}`;
    qEl.appendChild(exp);
  });

  const blanks = 30 - (right + wrong);
  const note20 = (right/30)*20;
  $cRight.textContent = String(right);
  $cWrong.textContent = String(wrong);
  $cBlank.textContent = String(blanks);
  $score.textContent = note20.toFixed(1);
  $export.disabled = false;
  saveState();
}

function exportTxt(){
  const lines = [];
  lines.push(`Teste ${CURRENT.testId} — Resultados`);
  lines.push(`Certas: ${$cRight.textContent}`);
  lines.push(`Erradas: ${$cWrong.textContent}`);
  lines.push(`Em branco: ${$cBlank.textContent}`);
  lines.push(`Nota (/20): ${$score.textContent}`);
  lines.push('');
  CURRENT.items.forEach((it, i)=>{
    const chosen = CURRENT.answers[it.id];
    const mark = (chosen===undefined) ? '—' : String.fromCharCode(65+chosen);
    const ok = String.fromCharCode(65+it.correct);
    lines.push(`Q${i+1}. ${it.stem}`);
    it.opts.forEach((op, idx)=>{
      const tag = String.fromCharCode(65+idx);
      const sel = (idx===chosen)?'*':' ';
      const cor = (idx===it.correct)?' (correta)':'';
      lines.push(`  ${sel} ${tag}) ${op}${cor}`);
    });
    lines.push(`  → Tua resposta: ${mark} | Correta: ${ok}`);
    if(it.explanation) lines.push(`  Obs.: ${it.explanation}`);
    lines.push('');
  });
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `resultado_teste_${CURRENT.testId}.txt`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function clearProgress(){
  localStorage.removeItem(storageKey());
  build($sel.value);
}

// ---------- Controlo UI ----------
$start.addEventListener('click', ()=>build($sel.value));
$submit.addEventListener('click', ()=>{
  const answered = Object.keys(CURRENT.answers).length;
  if(answered<30){
    const remain = 30-answered;
    if(!confirm(`Tens ${remain} pergunta(s) por responder. Queres entregar na mesma?`)){ return; }
  }
  evaluate();
});
$export.addEventListener('click', exportTxt);
$clear.addEventListener('click', clearProgress);
$sel.addEventListener('change', ()=>{
  build($sel.value);
});

// arranque inicial
build($sel.value);
</script>
</body>
</html>
