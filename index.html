<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz — GOC (CORONEL - 1)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --mute:#94a3b8; --acc:#22d3ee; --good:#22c55e; --bad:#ef4444;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,#0b1220 0,#0b1220ee 70%,#0b1220cc 100%),radial-gradient(1100px 500px at 110% -10%,#1f2937 0,#0b1220 60%);border:1px solid #1f2937;border-radius:18px;padding:20px 18px;box-shadow:0 10px 30px #0006}
  h1{font-size:1.6rem;margin:0 0 6px}
  .sub{color:var(--mute);margin:0 0 18px}
  select,button{font:inherit;color:var(--ink);background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
  select:focus,button:focus{outline:2px solid var(--acc);outline-offset:2px}
  button.primary{background:#0b1220;border-color:#334155}
  button.primary:hover{border-color:#475569}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;gap:10px;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:8px 12px;font-size:.95rem;color:var(--mute)}
  .q{margin:14px 0 18px;padding:16px;border:1px solid #1f2937;border-radius:14px;background:#0b1220b3}
  .q h3{font-size:1rem;margin:0 0 10px}
  .opts{display:grid;gap:8px}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid #1f2937;border-radius:10px;background:#0b1220}
  .opt input{margin-top:3px;accent-color:var(--acc)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;font-size:.8rem}
  .ok{background:color-mix(in srgb, var(--good) 20%, transparent);border:1px solid var(--good);color:#bbf7d0}
  .ko{background:color-mix(in srgb, var(--bad) 15%, transparent);border:1px solid var(--bad);color:#fecaca}
  .explain{color:var(--mute);margin-top:8px;font-size:.94rem}
  .sticky{position:sticky;top:0;z-index:3;background:linear-gradient(#0f172a,#0f172aCC 80%,transparent);padding:10px 0 6px;margin:-10px 0 10px}
  .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-top:16px}
  .counts{display:flex;gap:8px;flex-wrap:wrap}
  .k{border:1px solid #1f2937;border-radius:10px;padding:6px 10px;color:var(--mute)}
  .score{font-weight:700}
  .muted{color:var(--mute)}
  @media (prefers-reduced-motion:no-preference){ .q{transition:transform .15s ease, background .2s ease} .q:hover{transform:translateY(-1px)} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Quiz — GOC (CORONEL - 1)</h1>
    <p class="sub">Responde às 50 questões e só no fim verás a correção e a nota (/20). Progresso guardado localmente.</p>

    <div class="row" style="margin-bottom:12px">
      <label for="testSel" class="pill">Escolher teste:
        <select id="testSel" style="margin-left:8px">
          <option value="GOC_C1">GOC — CORONEL 1</option>
        </select>
      </label>
      <button id="startBtn" class="primary">Começar / Reiniciar</button>
      <span class="pill">Progresso: <span id="prog">0/50</span></span>
      <span class="pill">Estado: <span id="state">Em resposta</span></span>
    </div>

    <div id="quizArea"></div>

    <div class="sticky">
      <div class="footer">
        <div class="counts">
          <span class="k">Certas: <strong id="cRight">0</strong></span>
          <span class="k">Erradas: <strong id="cWrong">0</strong></span>
          <span class="k">Em branco: <strong id="cBlank">50</strong></span>
          <span class="k score">Nota (/20): <strong id="score">–</strong></span>
        </div>
        <div class="row">
          <button id="submitBtn" class="primary">Entregar</button>
          <button id="exportBtn" title="Exportar resultados para .txt" disabled>Exportar .txt</button>
          <button id="clearBtn" title="Limpar progresso">Limpar</button>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:8px">As perguntas e opções baralham a cada início. Progresso guardado localmente (por sessão).</p>
  </div>
</div>

<script>
function q(stem, options, correctIndex, explanation){ return { stem, options, correctIndex, explanation }; }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function uid(){ return Math.random().toString(36).slice(2); }

const el = (q)=>document.querySelector(q);
const $quiz   = el('#quizArea');
const $prog   = el('#prog');
const $state  = el('#state');
const $score  = el('#score');
const $cRight = el('#cRight');
const $cWrong = el('#cWrong');
const $cBlank = el('#cBlank');
const $submit = el('#submitBtn');
const $start  = el('#startBtn');
const $export = el('#exportBtn');
const $clear  = el('#clearBtn');
const $sel    = el('#testSel');

let CURRENT = { testId:'GOC_C1', items:[], answers:{}, key:{}, locked:false, evaluated:false, seed:'' };
function storageKey(){ return `be_quiz_${CURRENT.testId}`; }
function saveState(){ localStorage.setItem(storageKey(), JSON.stringify({ answers:CURRENT.answers, seed:CURRENT.seed })); }
function loadState(){ const raw=localStorage.getItem(storageKey()); if(!raw) return null; try{return JSON.parse(raw);}catch{return null;} }

/* ---------- TESTE GOC — CORONEL 1 (50 perguntas) ---------- */
const TEST_GOC_C1 = [
  q(`V/F — O SPQ é o conjunto integrado de entidades e organizações inter-relacionadas e interatuantes que assegura a coordenação de três subsistemas: normalização, qualificação e metrologia.`, [`Verdadeiro`, `Falso`], 0, `Definição do SPQ (Art. 4.º DL 71/2012).`),
  q(`V/F — O SPQ foi criado pelo Decreto-Lei n.º 234/93, de 2 de julho, e revisto pelo Decreto-Lei n.º 4/2002, de 4 de janeiro.`, [`Verdadeiro`, `Falso`], 0, `Suporte legal do SPQ (DL 234/93; DL 4/2002).`),
  q(`V/F — O órgão coordenador do SPQ é o Conselho Nacional da Qualidade (CNQ).`, [`Verdadeiro`, `Falso`], 0, `Slide: Órgão Coordenador — CNQ.`),
  q(`V/F — A horizontalidade do SPQ significa que apenas se aplica ao setor público.`, [`Verdadeiro`, `Falso`], 1, `Horizontalidade: pode abranger todos os setores de atividade da sociedade.`),
  q(`V/F — A coexistência no SPQ impede a adesão de sistemas setoriais ou entidades.`, [`Verdadeiro`, `Falso`], 1, `Coexistência: podem aderir sistemas/entidades que cumpram exigências.`),
  q(`V/F — O subsistema da metrologia garante o rigor e a exatidão das medições e assegura a sua comparabilidade e rastreabilidade.`, [`Verdadeiro`, `Falso`], 0, `Subsistema da Metrologia.`),
  q(`V/F — O subsistema da normalização enquadra apenas documentos normativos de âmbito interno (da própria organização).`, [`Verdadeiro`, `Falso`], 1, `Normalização: âmbito nacional, europeu e internacional.`),
  q(`V/F — O subsistema da qualificação enquadra atividades de acreditação, certificação e outras de avaliação da conformidade.`, [`Verdadeiro`, `Falso`], 0, `Subsistema da Qualificação.`),
  q(`V/F — Uma característica do SPQ é ser um sistema exclusivo, não admitindo outros sistemas voluntários ou obrigatórios.`, [`Verdadeiro`, `Falso`], 1, `Características: não é exclusivo; admite coexistência.`),
  q(`V/F — O desenvolvimento sustentável é referido como princípio da normalização.`, [`Verdadeiro`, `Falso`], 0, `Princípios da normalização — desenvolvimento sustentável.`),
  q(`V/F — A EFQM foi fundada em 1991 pelos líderes das 14 maiores empresas europeias.`, [`Verdadeiro`, `Falso`], 1, `EFQM: fundada em 1988; modelo introduzido em 1991.`),
  q(`V/F — O Modelo de Excelência EFQM foi introduzido em 1991 como base de trabalho para a avaliação dos European Quality Awards.`, [`Verdadeiro`, `Falso`], 0, `EFQM — introduzido em 1991.`),
  q(`V/F — No EFQM, o sistema de pontuação está dividido em 60% para os meios e 40% para os resultados.`, [`Verdadeiro`, `Falso`], 1, `Pontuação EFQM: 50% meios / 50% resultados.`),
  q(`V/F — O BSC utiliza apenas indicadores financeiros.`, [`Verdadeiro`, `Falso`], 1, `BSC: indicadores financeiros e não financeiros.`),
  q(`V/F — A CAF é um instrumento de autoavaliação que ajuda a desenvolver uma cultura de qualidade orientada para o cidadão/cliente.`, [`Verdadeiro`, `Falso`], 0, `CAF — cultura orientada para cidadão/cliente.`),
  q(`Segundo o Decreto‑Lei n.º 71/2012, a missão do IPQ inclui:`, [`A coordenação do SPQ e o desenvolvimento das atividades necessárias à função de laboratório nacional de metrologia`, `Apenas a emissão de licenças de construção`, `A fiscalização de tribunais administrativos`, `A gestão exclusiva de recursos humanos da Administração Pública`], 0, `Missão do IPQ (DL 71/2012).`),
  q(`Na definição do SPQ (Art. 4.º DL 71/2012), a coordenação assegurada é a dos subsistemas da:`, [`Normalização, qualificação e metrologia`, `Inspeção, auditoria e fiscalização`, `Formação, logística e finanças`, `Segurança, saúde e ambiente`], 0, `Três subsistemas do SPQ.`),
  q(`Qual destas é uma característica do SPQ (slide 'Características do SPQ')?`, [`Sistema descentralizado, com larga participação e regras claras e transparentes para a adesão`, `Sistema fechado, com adesão restrita a um único setor`, `Sistema exclusivo, que não admite coexistência`, `Sistema aplicável apenas a produtos, não a serviços`], 0, `Características do SPQ.`),
  q(`No slide de 'Características do SPQ', 'Aplicação Global' significa que o SPQ:`, [`Pode ser utilizado para qualquer tipo de produto ou serviço`, `Só se aplica a produtos industriais`, `Só se aplica a serviços públicos`, `Apenas se aplica a organizações certificadas ISO 9001`], 0, `Características — aplicação global.`),
  q(`O princípio de atuação 'Credibilidade e transparência' indica que o funcionamento do SPQ:`, [`Baseia‑se em regras e métodos conhecidos e aceites e é supervisionado por entidades representativas`, `Depende de decisões informais não documentadas`, `Dispensa supervisão por entidades externas`, `É definido unicamente por instruções internas`], 0, `Princípios — credibilidade e transparência.`),
  q(`O princípio de atuação 'Coexistência' significa que:`, [`Podem aderir ao SPQ sistemas setoriais ou entidades que demonstrem cumprir as exigências e regras estabelecidas`, `Só podem aderir entidades públicas`, `A adesão é proibida a entidades de âmbito setorial`, `O SPQ substitui todos os outros sistemas`], 0, `Princípios — coexistência.`),
  q(`O subsistema do SPQ que garante o rigor e a exatidão das medições chama‑se:`, [`Metrologia`, `Normalização`, `Qualificação`, `Certificação`], 0, `Subsistema da Metrologia.`),
  q(`O subsistema do SPQ que enquadra a elaboração de normas e documentos normativos é o da:`, [`Normalização`, `Metrologia`, `Qualificação`, `Avaliação de desempenho`], 0, `Subsistema da Normalização.`),
  q(`O subsistema da qualificação enquadra, no âmbito do SPQ, atividades de:`, [`Acreditação, certificação e outras de reconhecimento de competências e de avaliação da conformidade`, `Apenas criação de normas`, `Apenas medições laboratoriais`, `Apenas formação interna`], 0, `Subsistema da Qualificação.`),
  q(`No slide 'Princípios da Normalização', o desenvolvimento sustentável é descrito como garantindo que:`, [`As necessidades da sociedade na sua totalidade são integradas na normalização`, `A normalização se foca apenas em requisitos técnicos internos`, `A participação das partes interessadas é desincentivada`, `As normas são definidas sem envolvimento da sociedade`], 0, `Princípio: desenvolvimento sustentável.`),
  q(`A EFQM (Fundação Europeia para a Gestão da Qualidade) foi fundada em:`, [`1988`, `1991`, `2002`, `2015`], 0, `EFQM — fundada em 1988.`),
  q(`O Modelo Europeu de Excelência (EFQM) foi introduzido em 1991 como base de trabalho para:`, [`A avaliação dos European Quality Awards`, `A criação das Normas ISO 9000`, `A certificação obrigatória de todos os serviços públicos`, `A substituição do SPQ`], 0, `EFQM — European Quality Awards.`),
  q(`O modelo EFQM é descrito como um modelo de:`, [`Autoavaliação organizacional`, `Fiscalização judicial`, `Controlo disciplinar`, `Gestão exclusivamente financeira`], 0, `EFQM — autoavaliação.`),
  q(`Segundo o slide, o modelo EFQM assenta, entre outros, na necessidade de ter em conta:`, [`Partes interessadas, rede de processos, orientação para resultados e inovação/aprendizagem`, `Apenas custos financeiros e orçamento anual`, `Somente estrutura hierárquica`, `Apenas equipamentos e infraestruturas`], 0, `Pressupostos EFQM.`),
  q(`No EFQM, os nove critérios estão classificados em duas vertentes:`, [`Meios e Resultados`, `Planeamento e Execução`, `Estratégia e Operações`, `Pessoas e Tecnologia`], 0, `EFQM — Meios/Resultados.`),
  q(`No EFQM, 'Meios' correspondem a:`, [`A forma como os resultados são alcançados`, `O que a organização alcançou`, `Apenas resultados financeiros`, `Somente auditorias externas`], 0, `EFQM — definição de Meios.`),
  q(`Qual dos seguintes é um critério de 'Meios' no EFQM?`, [`Parcerias e Recursos`, `Resultados‑chave do desempenho`, `Para a sociedade`, `Resultados externos`], 0, `EFQM — Meios: Parcerias e Recursos.`),
  q(`No EFQM, o critério 'Processos' refere que os processos são:`, [`Sistematicamente concebidos e geridos, melhorados através da inovação, satisfazendo e gerando valor para os stakeholders`, `Improvisados consoante o momento`, `Definidos apenas para cumprir formalidades`, `Exclusivos de áreas financeiras`], 0, `EFQM — Processos.`),
  q(`O sistema de pontuação do EFQM está dividido:`, [`50% para os meios e 50% para os resultados`, `70% para os meios e 30% para os resultados`, `40% para os meios e 60% para os resultados`, `Apenas por resultados (100%)`], 0, `EFQM — pontuação 50/50.`),
  q(`Qual destas é apontada como desvantagem do EFQM?`, [`Utiliza um conjunto muito vasto de indicadores, dificultando o controlo`, `Baseia‑se em relações causa‑efeito entre indicadores`, `Só é aplicável a um único setor`, `Não utiliza indicadores`], 0, `EFQM — desvantagens.`),
  q(`O BSC é apresentado como uma metodologia que se apoia em conceitos da gestão da qualidade total, como:`, [`Orientação para os clientes, gestão por processos, melhoria contínua e gestão de desempenho`, `Apenas punição e controlo disciplinar`, `Somente auditorias externas`, `Exclusivamente gestão orçamental`], 0, `BSC — ligação à qualidade total.`),
  q(`Segundo o slide, a aplicação prática do BSC levou ao seu desenvolvimento de:`, [`Metodologia de avaliação da performance para metodologia de gestão estratégica`, `Metodologia de gestão estratégica para modelo de auditoria`, `Modelo de metrologia para modelo de normalização`, `Modelo jurídico para modelo financeiro`], 0, `BSC — evolução.`),
  q(`No slide, o BSC reflete equilíbrio entre:`, [`Objetivos de curto e longo prazo, medidas financeiras e não‑financeiras, e perspetivas interna e externa`, `Apenas metas internas e externas sem indicadores`, `Somente resultados financeiros de curto prazo`, `Apenas ocorrências e tendências, sem estratégia`], 0, `BSC — equilíbrios.`),
  q(`Segundo o slide, a metodologia BSC pressupõe a definição de missão, visão, valores e estratégia através de:`, [`Indicadores do desempenho (financeiros e não financeiros) e elaboração de mapas estratégicos`, `Apenas relatórios anuais financeiros`, `Apenas organigramas`, `Apenas regulamentos internos`], 0, `BSC — pressupostos.`),
  q(`No slide, o Mapa Estratégico no BSC envolve:`, [`Objetivos distribuídos pelas perspetivas, atendendo aos vetores estratégicos`, `Apenas a lista de tarefas diárias`, `Apenas indicadores financeiros`, `Apenas a estrutura hierárquica`], 0, `BSC — mapa estratégico.`),
  q(`Uma das vantagens da aplicação do BSC (slide) é:`, [`Transformar a visão e a estratégia em ações`, `Eliminar a necessidade de estratégia`, `Evitar o alinhamento dos colaboradores`, `Substituir a medição do desempenho`], 0, `BSC — vantagens.`),
  q(`Em suma, o BSC é descrito como:`, [`Modelo integrado de quantificação do desempenho organizacional que proporciona uma visão global e integrada através de indicadores por perspetivas`, `Modelo que substitui todos os indicadores por perceções`, `Modelo de metrologia aplicado a medições físicas`, `Modelo exclusivamente de normalização`], 0, `BSC — em suma.`),
  q(`CAF significa:`, [`Common Assessment Framework`, `Common Audit Framework`, `Central Assessment Framework`, `Common Allocation Framework`], 0, `CAF — sigla.`),
  q(`No slide, 'Estrutura' no CAF pressupõe:`, [`Um conjunto de princípios agrupados de forma lógica e coerente para efetuar um diagnóstico da organização`, `Apenas um organigrama hierárquico`, `Apenas regras financeiras`, `Apenas um manual técnico`], 0, `CAF — 'Estrutura'.`),
  q(`No slide, 'Avaliação' no CAF engloba:`, [`As necessidades de melhoria nos sítios onde sejam necessárias`, `Apenas a atribuição de prémios de qualidade`, `Apenas a fiscalização disciplinar`, `Apenas auditorias financeiras externas`], 0, `CAF — 'Avaliação'.`),
  q(`No CAF, o critério 1 (Liderança) inclui, entre outros, o subcritério 1.1:`, [`Dar uma orientação à organização, desenvolvendo a visão, missão e valores`, `Obter informação sobre necessidades futuras das partes interessadas`, `Planear, implementar e rever a modernização e a inovação`, `Resultados externos e internos`], 0, `CAF — 1.1 Liderança.`),
  q(`Segundo o slide, a CAF permite aos gestores públicos:`, [`Melhorar competências de gestão e aplicar uma ferramenta de qualidade através de autoavaliação`, `Substituir a necessidade de avaliação`, `Eliminar benchmarking e benchlearning`, `Focar apenas em resultados financeiros`], 0, `CAF — para gestores públicos.`),
  q(`Segundo o slide, os modelos de excelência são tipicamente vistos como instrumentos de:`, [`Autoavaliação`, `Fiscalização judicial`, `Metrologia industrial`, `Normalização interna`], 0, `Aplicação conjunta — instrumentos de autoavaliação.`),
  q(`O slide indica que, por serem de aplicação genérica, os modelos de excelência permitem:`, [`Efetuar comparações entre organizações do setor público e privado`, `Apenas comparações dentro do mesmo setor`, `Comparações apenas entre organizações públicas`, `Eliminar qualquer comparação`], 0, `Aplicação conjunta — comparações público/privado.`),
  q(`De acordo com o slide, para atingir a Qualidade Total são usados com frequência:`, [`EFQM, Normas ISO 9000, BSC e CAF`, `Apenas EFQM e CAF`, `Apenas ISO 9000 e metrologia`, `Somente BSC e normalização`], 0, `Aplicação conjunta — modelos frequentes.`),
];

let quizChangeHandler=null;

function build(testId){
  CURRENT.testId=testId;
  const base=TEST_GOC_C1;

  const seed=uid();
  CURRENT.seed=seed;

  const items = shuffle(base).map((qItem,i)=>{
    const idxMap = Array.from({length:qItem.options.length}, (_,k)=>k);
    const shuffledIdxs = shuffle(idxMap);
    const opts = shuffledIdxs.map(k=>qItem.options[k]);
    const correct = shuffledIdxs.indexOf(qItem.correctIndex);
    return {
      id:`${testId}-${i+1}`,
      stem:qItem.stem,
      opts:opts,
      correct:correct,
      explanation:qItem.explanation||''
    };
  });

  CURRENT.items = items.slice(0, 50);
  CURRENT.answers = {};
  CURRENT.key = Object.fromEntries(CURRENT.items.map(it=>[it.id,it.correct]));
  CURRENT.locked=false;
  CURRENT.evaluated=false;

  if(quizChangeHandler) $quiz.removeEventListener('change', quizChangeHandler);
  render();
  localStorage.removeItem(storageKey());
  updateCounts();
}

function render(){
  $quiz.innerHTML='';
  CURRENT.items.forEach((qItem, idx)=>{
    const wrap=document.createElement('div');
    wrap.className='q';
    wrap.dataset.qid=qItem.id;

    const h=document.createElement('h3');
    h.innerHTML=`<span class="muted">Q${idx+1}.</span> ${qItem.stem}`;

    const opts=document.createElement('div');
    opts.className='opts';

    qItem.opts.forEach((opt, i)=>{
      const id=`${qItem.id}-o${i}`;
      const line=document.createElement('label');
      line.className='opt';
      line.innerHTML=`
        <input type="radio" name="${qItem.id}" id="${id}" value="${i}">
        <div>${opt}</div>
      `;
      opts.appendChild(line);
    });

    wrap.appendChild(h);
    wrap.appendChild(opts);
    $quiz.appendChild(wrap);
  });

  $state.textContent='Em resposta';
  $score.textContent='–';
  $cRight.textContent='0';
  $cWrong.textContent='0';
  $cBlank.textContent=String(CURRENT.items.length);
  $export.disabled=true;

  quizChangeHandler=onSelect;
  $quiz.addEventListener('change', quizChangeHandler, { passive:true });
}

function onSelect(e){
  if(!e.target || e.target.type!=='radio') return;
  if(CURRENT.locked) return;
  const name=e.target.name;
  const val=Number(e.target.value);
  CURRENT.answers[name]=val;
  saveState();
  updateCounts();
}

function updateCounts(){
  const answered=Object.keys(CURRENT.answers).length;
  $prog.textContent=`${answered}/${CURRENT.items.length}`;
  $cBlank.textContent=String(CURRENT.items.length-answered);
}

function evaluate(){
  CURRENT.locked=true;
  CURRENT.evaluated=true;
  $state.textContent='Corrigido';
  let right=0, wrong=0;

  document.querySelectorAll('.q').forEach(qEl=>{
    const qid=qEl.dataset.qid;
    const item=CURRENT.items.find(x=>x.id===qid);
    const chosen=CURRENT.answers[qid];
    const correct=item.correct;

    const labels=qEl.querySelectorAll('.opt');
    labels.forEach((lab,i)=>{
      const input=lab.querySelector('input');
      input.disabled=true;
      if(i===correct) lab.classList.add('ok');
      if(chosen!==undefined && i===chosen && chosen!==correct) lab.classList.add('ko');
    });

    const badge=document.createElement('span');
    badge.className='badge ' + (chosen===correct ? 'ok' : 'ko');
    badge.textContent=(chosen===correct ? 'Correto' : (chosen===undefined ? 'Em branco' : 'Incorreto'));
    qEl.querySelector('h3').appendChild(document.createTextNode(' '));
    qEl.querySelector('h3').appendChild(badge);

    const exp=document.createElement('div');
    exp.className='explain';
    const correctTxt=item.opts[correct];

    if(chosen===correct) right++;
    else if(chosen===undefined) { /* branco */ }
    else wrong++;

    const showExplain = (chosen!==correct) && item.explanation;
    exp.innerHTML = `<strong>Resposta correta:</strong> ${correctTxt}` + (showExplain ? ` — <em>${item.explanation}</em>` : ``);
    qEl.appendChild(exp);
  });

  const blanks=CURRENT.items.length-(right+wrong);
  const note20=(right/CURRENT.items.length)*20;
  $cRight.textContent=String(right);
  $cWrong.textContent=String(wrong);
  $cBlank.textContent=String(blanks);
  $score.textContent=note20.toFixed(1);
  $export.disabled=false;
  saveState();
}

function exportTxt(){
  const lines=[];
  lines.push(`Teste ${CURRENT.testId} — Resultados`);
  lines.push(`Certas: ${$cRight.textContent}`);
  lines.push(`Erradas: ${$cWrong.textContent}`);
  lines.push(`Em branco: ${$cBlank.textContent}`);
  lines.push(`Nota (/20): ${$score.textContent}`);
  lines.push('');
  CURRENT.items.forEach((it,i)=>{
    const chosen=CURRENT.answers[it.id];
    const mark=(chosen===undefined)?'—':String.fromCharCode(65+chosen);
    const ok=String.fromCharCode(65+it.correct);
    lines.push(`Q${i+1}. ${it.stem}`);
    it.opts.forEach((op,idx)=>{
      const tag=String.fromCharCode(65+idx);
      const sel=(idx===chosen)?'*':' ';
      const cor=(idx===it.correct)?' (correta)':'';
      lines.push(`  ${sel} ${tag}) ${op}${cor}`);
    });
    lines.push(`  → Tua resposta: ${mark} | Correta: ${ok}`);
    lines.push('');
  });
  const blob=new Blob([lines.join('\n')], {type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`resultado_teste_${CURRENT.testId}.txt`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function clearProgress(){ localStorage.removeItem(storageKey()); build($sel.value); }

$start.addEventListener('click', ()=>build($sel.value));
$submit.addEventListener('click', ()=>{
  const answered=Object.keys(CURRENT.answers).length;
  if(answered<CURRENT.items.length){
    const remain=CURRENT.items.length-answered;
    if(!confirm(`Tens ${remain} pergunta(s) por responder. Queres entregar na mesma?`)) return;
  }
  evaluate();
});
$export.addEventListener('click', exportTxt);
$clear.addEventListener('click', clearProgress);
$sel.addEventListener('change', ()=>build($sel.value));

build($sel.value);
</script>
</body>
</html>
